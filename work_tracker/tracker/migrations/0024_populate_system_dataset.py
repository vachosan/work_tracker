# Generated by Django 4.2.23 on 2026-01-06 14:58

from django.db import migrations


def populate_system_dataset(apps, schema_editor):
    Dataset = apps.get_model("tracker", "Dataset")
    DatasetTree = apps.get_model("tracker", "DatasetTree")
    ProjectTree = apps.get_model("tracker", "ProjectTree")
    WorkRecord = apps.get_model("tracker", "WorkRecord")

    dataset, _ = Dataset.objects.get_or_create(
        is_system=True,
        defaults={
            "name": "Veřejná stromová mapa",
            "visibility": "PUBLIC",
            "allow_public_observations": True,
        },
    )

    records = list(WorkRecord.objects.values_list("pk", flat=True))
    dataset_tree_objs = [
        DatasetTree(dataset=dataset, tree_id=tree_id)
        for tree_id in records
    ]
    if dataset_tree_objs:
        DatasetTree.objects.bulk_create(dataset_tree_objs, ignore_conflicts=True)

    project_records = WorkRecord.objects.filter(project_id__isnull=False).values_list(
        "project_id", "pk"
    )
    project_tree_objs = [
        ProjectTree(project_id=project_id, tree_id=tree_id)
        for project_id, tree_id in project_records
    ]
    if project_tree_objs:
        ProjectTree.objects.bulk_create(project_tree_objs, ignore_conflicts=True)


class Migration(migrations.Migration):

    dependencies = [
        ('tracker', '0023_dataset_projecttree_datasettree_project_trees_and_more'),
    ]

    operations = [
        migrations.RunPython(populate_system_dataset, migrations.RunPython.noop),
    ]
