{% extends "tracker/base.html" %}
{% block title %}Test Mapy.cz Leaflet{% endblock %}
{% block content %}
<div class="container py-3">
  <h5>Test Mapy.cz Leaflet API</h5>
  <div id="map" style="width:100%; height:400px; border-radius:10px;"></div>
</div>

<!-- Leaflet CSS & JS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.2/dist/leaflet.css"
  integrity="sha256-sA+zWATbFveLLNqWO2gtiw3HL/lh1giY/Inf1BJ0z14="
  crossorigin=""
/>
<script
  src="https://unpkg.com/leaflet@1.9.2/dist/leaflet.js"
  integrity="sha256-o9N1jGDZrf5tS+Ft4gbIK7mYMipq9lqpVJ91xHSyKhg="
  crossorigin=""
></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const API_KEY = "{{ mapy_key }}";

  // 1️⃣ Vytvoření mapy
  const map = L.map("map").setView([49.8729317, 14.8981184], 13);

  // 2️⃣ Načtení dlaždic z Mapy.cz API
  L.tileLayer(`https://api.mapy.com/v1/maptiles/basic/256/{z}/{x}/{y}?apikey=${API_KEY}`, {
    minZoom: 0,
    maxZoom: 19,
    attribution:
      '<a href="https://api.mapy.com/copyright" target="_blank">&copy; Seznam.cz a.s. a další</a>',
  }).addTo(map);

  // 3️⃣ Přidání loga Mapy.com (povinné)
  const LogoControl = L.Control.extend({
    options: { position: "bottomleft" },
    onAdd: function (map) {
      const container = L.DomUtil.create("div");
      const link = L.DomUtil.create("a", "", container);
      link.href = "http://mapy.com/";
      link.target = "_blank";
      link.innerHTML = '<img src="https://api.mapy.com/img/api/logo.svg" width="100px" />';
      L.DomEvent.disableClickPropagation(link);
      return container;
    },
  });
  new LogoControl().addTo(map);

  // 4️⃣ Získání polohy uživatele
  if ("geolocation" in navigator) {
    navigator.geolocation.getCurrentPosition(
        function (pos) {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;

            L.marker([lat, lon])
                .addTo(map)
                .bindPopup(`<b>Tady jsi!</b><br>Lat: ${lat.toFixed(5)}, Lon: ${lon.toFixed(5)}`)
                .openPopup();

            map.setView([lat, lon], 16);
        },
        function (error) {
            console.error("Chyba při získávání polohy:", error);
            alert("Nepodařilo se získat vaši polohu. Používám výchozí (Ostrava).");

    // fallback na Ostravu
            const lat = 49.83465;
            const lon = 18.28204;
            L.marker([lat, lon])
                .addTo(map)
                .bindPopup("Výchozí poloha: Ostrava")
                .openPopup();

            map.setView([lat, lon], 13);
    },
    {
        enableHighAccuracy: true,  // zkusí GPS, ne IP
        timeout: 5000,             // max. 5 s čekání
        maximumAge: 0
    }
    );

  } else {
    alert("Tento prohlížeč nepodporuje geolokaci.");
  }
});
</script>
{% endblock %}
