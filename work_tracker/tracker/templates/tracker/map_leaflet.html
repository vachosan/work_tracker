{% extends "tracker/base.html" %}
{% load static %}
{% block title %}Mapa{% endblock %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/map_ui.css' %}">
<style>
  html, body { height: 100%; overflow: hidden; }
  body { margin: 0; }
  /* fullscreen map overrides */
  main.container { padding: 0 !important; max-width: none; }
  nav.navbar, footer { display: none; }
  /* map fills viewport */
  #map { position: fixed; inset: 0; z-index: 1; }
</style>
<!-- Fullscreen map -->
<div id="map"></div>

{% include "tracker/partials/map_ui.html" %}

<!-- Leaflet and plugins -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.2/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.2/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css">
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<!-- Data for JS -->
{{ records_for_select|json_script:"records-data" }}
{{ records_with_coords|json_script:"coords-data" }}
{{ projects_js|json_script:"projects-data" }}

<script>
document.addEventListener('DOMContentLoaded', function () {
  const API_KEY = "{{ mapy_key }}";
  const wrIcon = L.divIcon({ className: 'wr-dot', iconSize: [12,12] });

  const recordsForSelect = JSON.parse(document.getElementById('records-data').textContent);
  const projectSelect = document.getElementById('projectSelect');
  const backLink = document.getElementById('mapBackLink');
  const saveFab = document.getElementById('saveFab');
  const createFab = document.getElementById('createFab');
  const locateBtn = document.getElementById('locateBtn');
  const labelsCheckbox = document.getElementById('labelsCheckbox');
  const labelSizeSelect = document.getElementById('labelSizeSelect');
  const photoViewer = document.getElementById('photoViewer');
  const photoViewerImg = photoViewer ? photoViewer.querySelector('img') : null;
  const photoViewerPrev = photoViewer ? photoViewer.querySelector('.pv-prev') : null;
  const photoViewerNext = photoViewer ? photoViewer.querySelector('.pv-next') : null;
  const photoViewerClose = photoViewer ? photoViewer.querySelector('.pv-close') : null;
  const photoCaptureInput = document.getElementById('photoCaptureInput');
  const photoCaptureModal = document.getElementById('photoCaptureModal');
  const capturePreview = document.getElementById('capturePreview');
  const captureCommentToggle = document.getElementById('captureCommentToggle');
  const captureCommentWrap = document.getElementById('captureCommentWrap');
  const captureCommentInput = document.getElementById('captureCommentInput');
  const captureSaveBtn = document.getElementById('captureSaveBtn');
  const captureCancelBtn = document.getElementById('captureCancelBtn');
  const newRecordModal = document.getElementById('newRecordModal');
  const newRecordTitleInput = document.getElementById('newRecordTitle');
  const taxonDisplayInput = document.getElementById('taxon_display');
  const taxonSuggestionsList = document.getElementById('taxon-suggestions');
  const taxonFieldWrapper = document.getElementById('taxon-field-wrapper');
  const taxonCzechInput = document.getElementById('taxon_czech');
  const taxonLatinInput = document.getElementById('taxon_latin');
  const taxonGbifKeyInput = document.getElementById('taxon_gbif_key');
  const bottomPanel = document.getElementById('bottom-panel');
  const treePanel = document.getElementById('tree-panel');
  let activeTreePanelRecordId = null;
  const projectParam = new URLSearchParams(window.location.search).get('project');

  function buildReturnParam() {
    return encodeURIComponent(window.location.pathname + window.location.search);
  }

  function buildDetailUrl(recordId) {
    const base = `/tracker/${recordId}/`;
    const params = [];
    if (projectParam) params.push(`project=${encodeURIComponent(projectParam)}`);
    params.push(`return=${buildReturnParam()}`);
    return `${base}?${params.join('&')}`;
  }

  function openBottomPanel() {
    if (bottomPanel) bottomPanel.classList.add('open');
  }

  function closeBottomPanel() {
    if (bottomPanel) bottomPanel.classList.remove('open');
  }

  if (treePanel) {
    treePanel.addEventListener('click', (event) => {
      if (event.target.closest('.tree-panel-close')) {
        event.preventDefault();
        closeTreePanel();
      }
    });
  }
  const taxonSuggestUrl = "{% url 'gbif_taxon_suggest' %}";
  let taxonRequestId = 0;
  const newRecordSaveBtn = document.getElementById('newRecordSaveBtn');
  const newRecordCancelBtn = document.getElementById('newRecordCancelBtn');
  const newRecordCloseBtn = document.getElementById('newRecordCloseBtn');
  const assessmentModal = document.getElementById('assessmentModal');
  const assessmentWorkRecordIdInput = document.getElementById('assessmentWorkRecordId');
  const assessmentStemDiameterHidden = document.getElementById('stem_d_cm_hidden');
  const assessmentStemCircumferenceHidden = document.getElementById('stem_c_cm_hidden');
  const assessmentStemDiametersListHidden = document.getElementById('stem_diameters_cm_list_hidden');
  const assessmentStemCircumferencesListHidden = document.getElementById('stem_circumferences_cm_list_hidden');
  const stemsList = document.getElementById('stems-list');
  const stemAddBtn = document.getElementById('stemAddBtn');
  const assessmentHeightInput = document.getElementById('assessmentHeight');
  const assessmentCrownWidthInput = document.getElementById('assessmentCrownWidth');
  const assessmentCrownAreaInput = document.getElementById('assessmentCrownArea');
  const assessmentCrownAreaHint = document.getElementById('assessmentCrownAreaHint');
  const assessmentPhysAge = document.getElementById('assessmentPhysAge');
  const assessmentVitality = document.getElementById('assessmentVitality');
  const assessmentHealth = document.getElementById('assessmentHealth');
  const assessmentStability = document.getElementById('assessmentStability');
  const assessmentMistletoe = document.getElementById('assessmentMistletoe');
  const assessmentPerspectiveSlider = document.getElementById('assessmentPerspectiveSlider');

  const assessmentPhysAgeValue = document.getElementById('assessmentPhysAgeValue');
  const assessmentVitalityValue = document.getElementById('assessmentVitalityValue');
  const assessmentHealthValue = document.getElementById('assessmentHealthValue');
  const assessmentStabilityValue = document.getElementById('assessmentStabilityValue');
  const assessmentMistletoeValue = document.getElementById('assessmentMistletoeValue');
  const assessmentPerspectiveValue = document.getElementById('assessmentPerspectiveValue');

  const assessmentCloseBtn = document.getElementById('assessmentCloseBtn');
  const assessmentCancelBtn = document.getElementById('assessmentCancelBtn');
  const assessmentSaveBtn = document.getElementById('assessmentSaveBtn');
  const assessmentMessage = document.getElementById('assessmentMessage');
  let assessmentScales = {};
  let mistletoeScales = {};
  const interventionModal = document.getElementById('interventionModal');
  const interventionForm = document.getElementById('interventionForm');
  const interventionTreeIdInput = document.getElementById('interventionTreeId');
  const interventionNoteHintModal = document.getElementById('interventionNoteHintModal');
  const interventionFormErrors = document.getElementById('interventionFormErrors');
  const interventionCloseBtn = document.getElementById('interventionCloseBtn');
  const interventionCancelBtn = document.getElementById('interventionCancelBtn');
  const interventionSaveBtn = document.getElementById('interventionSaveBtn');
  const interventionTypeSelect = document.getElementById('id_intervention_type');
  const interventionApiTemplate = interventionModal ? interventionModal.dataset.apiTemplate || '' : '';
  const interventionNoteData = {{ intervention_note_data_json|default:"{}" | safe }};
  let interventionListContainer = document.getElementById('intervention-list');

  if (interventionModal && interventionForm && !interventionListContainer) {
    interventionListContainer = document.createElement('div');
    interventionListContainer.id = 'intervention-list';
    interventionListContainer.className = 'mb-2 small';
    interventionForm.parentNode.insertBefore(interventionListContainer, interventionForm);
  }

  const interventionDueDateInput = document.getElementById('id_due_date');
  if (interventionDueDateInput && interventionModal) {
    const dueWrapper = interventionDueDateInput.closest('.col-6') || interventionDueDateInput.parentElement;
    if (dueWrapper) {
      dueWrapper.classList.add('d-none');
    }
  }

  function clearTaxonSelection() {
    if (taxonCzechInput) taxonCzechInput.value = '';
    if (taxonLatinInput) taxonLatinInput.value = '';
    if (taxonGbifKeyInput) taxonGbifKeyInput.value = '';
  }

  function hideTaxonSuggestions() {
    if (!taxonSuggestionsList) return;
    taxonSuggestionsList.classList.remove('visible');
    taxonSuggestionsList.innerHTML = '';
  }

  function clearList() {
    hideTaxonSuggestions();
  }

  function renderTaxonSuggestions(items) {
    if (!taxonSuggestionsList) return;
    taxonSuggestionsList.innerHTML = '';
    if (!items.length) {
      hideTaxonSuggestions();
      return;
    }
    items.forEach(item => {
      const btn = document.createElement('li');
      const label = item.display || item.scientific_name || item.vernacular_name || '';
      btn.textContent = label;
      btn.classList.add('list-group-item', 'list-group-item-action');
      btn.addEventListener('click', () => {
        if (taxonDisplayInput) {
          taxonDisplayInput.value = label;
        }
        if (taxonCzechInput) {
          taxonCzechInput.value = item.vernacular_name || '';
        }
        if (taxonLatinInput) {
          taxonLatinInput.value = item.scientific_name || '';
        }
        if (taxonGbifKeyInput) {
          taxonGbifKeyInput.value = item.gbif_key || '';
        }
        clearList();
      });
      taxonSuggestionsList.appendChild(btn);
    });
    taxonSuggestionsList.classList.add('visible');
  }

  function requestTaxonSuggestions(query) {
    if (!taxonSuggestUrl) return;
    const requestId = ++taxonRequestId;
    fetch(`${taxonSuggestUrl}?q=${encodeURIComponent(query)}`)
      .then(resp => (resp.ok ? resp.json() : Promise.resolve({ results: [] })))
      .then(data => {
        if (requestId !== taxonRequestId) return;
        renderTaxonSuggestions(data.results || []);
      })
      .catch(() => {
        if (requestId === taxonRequestId) {
          hideTaxonSuggestions();
        }
      });
  }

  // Deep-link params
  const urlParams = new URLSearchParams(window.location.search);
  const paramRecord = urlParams.get('record');
  const paramProject = urlParams.get('project');
  const paramLocate = urlParams.has('locate');
  const assessmentApiBase = "{% url 'workrecord_assessment_api' 0 %}".replace("0/assessment/", "");
  const workRecordDetailApiBase = "{% url 'workrecord_detail_api' 0 %}".replace(/0\/?$/, "");

  // currently selected work record (for saving coordinates)
  let activeRecordId = paramRecord || null;

  function updateBackLink(rid) {
    const id = rid || activeRecordId;
    if (!backLink) return;
    backLink.href = id ? buildDetailUrl(id) : `{% url 'work_record_list' %}`;
  }
  updateBackLink(activeRecordId);

  if (projectSelect) {
    projectSelect.addEventListener('change', () => {
      updateMarkers(projectSelect.value);
    });
  }

  // Map init and saved view
  const savedView = (()=>{ try { return JSON.parse(localStorage.getItem('wt_map_view')); } catch(e){ return null } })();
  const map = L.map('map', { minZoom: 3, maxZoom: 20, zoomControl: false });
  if (savedView && Array.isArray(savedView.center) && typeof savedView.zoom === 'number') {
    map.setView(savedView.center, savedView.zoom);
  } else {
    map.setView([49.83465, 18.28204], 15);
  }
  map.on('moveend zoomend', () => {
    const c = map.getCenter();
    localStorage.setItem('wt_map_view', JSON.stringify({ center: [c.lat, c.lng], zoom: map.getZoom() }));
  });

  let isDragging = false;
  let isZooming = false;
  map.on('dragstart', () => { isDragging = true; });
  map.on('dragend', () => {
    setTimeout(() => {
      isDragging = false;
    }, 0);
  });
  map.on('zoomstart', () => { isZooming = true; });
  map.on('zoomend', () => {
    setTimeout(() => {
      isZooming = false;
    }, 0);
  });

  // Mapy.cz layer: aerial (orthophoto only)
  const aerial = L.tileLayer(
    `https://api.mapy.com/v1/maptiles/aerial/256/{z}/{x}/{y}?apikey=${API_KEY}`,
    { attribution: '&copy; <a href="https://mapy.cz/">Seznam.cz a.s.</a>', maxZoom: 20, minZoom: 3 }
  ).addTo(map);

  // Transparent labels+boundaries overlay (names-overlay) above orthophoto
  const labelsOverlay = L.tileLayer(
    `https://api.mapy.com/v1/maptiles/names-overlay/256/{z}/{x}/{y}?apikey=${API_KEY}`,
    {
      attribution: '&copy; <a href="https://mapy.cz/">Seznam.cz a.s.</a>',
      maxZoom: 20,
      minZoom: 3,
      zIndex: 2,
      opacity: 1,
      errorTileUrl: 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw=='
    }
  ).addTo(map);

  let myLocationCircle = null;
  const shouldCenterOnUser = paramLocate || (!paramRecord && !paramProject && !savedView);

  // Geolocation
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        if (shouldCenterOnUser) map.setView([lat, lon], 18);
        if (myLocationCircle) { try { map.removeLayer(myLocationCircle); } catch(e){} }
        myLocationCircle = L.circle([lat, lon], {
          radius: 5,
          color: '#007bff',
          fillColor: '#007bff',
          fillOpacity: 0.7,
          weight: 2
        }).addTo(map);
      },
      err => { console.warn('GPS nedostupná:', err); },
      { enableHighAccuracy: true, timeout: 4000 }
    );
  }

  // Manual locate action
  if (locateBtn) {
    locateBtn.addEventListener('click', function() {
      if (!navigator.geolocation) return;
      navigator.geolocation.getCurrentPosition(
        pos => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          map.setView([lat, lon], Math.max(map.getZoom(), 18));
          if (myLocationCircle) { try { map.removeLayer(myLocationCircle); } catch(e){} }
          myLocationCircle = L.circle([lat, lon], {
            radius: 5,
            color: '#007bff',
            fillColor: '#007bff',
            fillOpacity: 0.7,
            weight: 2
          }).addTo(map);
        },
        err => { console.warn('GPS nedostupná:', err); },
        { enableHighAccuracy: true, timeout: 4000 }
      );
    });
  }

  // Click to select point
  let selectedLat = null;
  let selectedLon = null;
  let marker = null;
  map.on('click', function (e) {
    if (!isDragging && !isZooming) {
      closeTreePanel();
    }
    const { lat, lng } = e.latlng;
    selectedLat = lat.toFixed(7);
    selectedLon = lng.toFixed(7);
    if (marker) map.removeLayer(marker);
    marker = L.circleMarker([lat, lng], {
      color: '#28a745',
      fillColor: '#28a745',
      fillOpacity: 0.9,
      radius: 7,
      weight: 2
    }).addTo(map);

    if (saveFab) saveFab.disabled = false;
  });

  function handleSave() {
      const recordId = activeRecordId;
      if (!recordId) {
        alert('Chybí ID úkonu. Otevři mapu z detailu úkonu.');
        return;
      }
      if (!selectedLat || !selectedLon) return alert('Nejdřív klikni do mapy.');
      fetch("{% url 'save_coordinates' %}", {
        method: 'POST',
        headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ record_id: recordId, latitude: selectedLat, longitude: selectedLon })
      })
      .then(resp => resp.json())
      .then(data => {
        if (data.status === 'ok') {
          const recIdNum = Number(recordId);
          const recInfo = recordsForSelect.find(r => Number(r.id) === recIdNum);
          if (recInfo) { recInfo.has_coords = true; }
          const existing = records.find(r => Number(r.id) === recIdNum);
          if (existing) {
            existing.lat = Number(selectedLat);
            existing.lon = Number(selectedLon);
            existing.project_id = recInfo ? recInfo.project_id : existing.project_id ?? null;
            existing.project = existing.project ?? (recInfo && recInfo.project_name ? recInfo.project_name : '');
          } else {
            records.push({
              id: recIdNum,
              title: recInfo ? (recInfo.title || '') : '',
              external_tree_id: recInfo ? (recInfo.external_tree_id || '') : '',
              taxon: '',
              project: '',
              project_id: recInfo ? recInfo.project_id : null,
              lat: Number(selectedLat),
              lon: Number(selectedLon),
              photos: [],
              has_assessment: false,
              has_photos: false,
            });
          }
          if (typeof updateMarkers === 'function') updateMarkers(projectSelect ? projectSelect.value : '');
          map.setView([Number(selectedLat), Number(selectedLon)], Math.max(map.getZoom(), 18));
          window.location.href = buildDetailUrl(recIdNum);
        } else {
          alert('Chyba: ' + data.msg);
        }
      })
      .catch(err => alert('Chyba při komunikaci se serverem: ' + err));
  }

  // Save from floating FAB
  if (saveFab) { saveFab.addEventListener('click', handleSave); }

  // Create new record, prefill selected coordinates via query string
  if (createFab) {
    createFab.addEventListener('click', function() {
      if (!selectedLat || !selectedLon) {
        alert('Nejdřív klikni do mapy a vyber bod.');
        return;
      }
      let url = '/tracker/create/';
      const projVal = projectSelect ? projectSelect.value : '';
      if (projVal && projVal !== 'none') { url += `${projVal}/`; }
      const params = [];
      params.push(`lat=${selectedLat}`);
      params.push(`lon=${selectedLon}`);
      if (params.length) url += `?${params.join('&')}`;
      window.location.href = url;
    });
  }

  // Existing records and clustering
  let records = JSON.parse(document.getElementById('coords-data').textContent);
  const detailLoadingRecords = new Set();

  function detailApiUrlFor(recordId) {
    return `${workRecordDetailApiBase}${recordId}/`;
  }

  function findRecordById(recordId) {
    const idNum = Number(recordId);
    if (Number.isNaN(idNum)) return null;
    return records.find(r => Number(r.id) === idNum) || null;
  }
  const clusterLayer = L.markerClusterGroup({ disableClusteringAtZoom: 17, spiderfyOnMaxZoom: true, chunkedLoading: true });
  map.addLayer(clusterLayer);

  const markers = [];
  let labelsEnabled = labelsCheckbox ? labelsCheckbox.checked : true;
  let labelSize = labelSizeSelect ? labelSizeSelect.value : 'small';
  const LABEL_MAX_ZOOM = map.getMaxZoom();
  const LABEL_MIN_ZOOM = Math.max(LABEL_MAX_ZOOM - 1, 0);

  function getRecordDisplayLabel(record) {
    if (record.display_label && String(record.display_label).trim()) {
      return String(record.display_label).trim();
    }
    if (record.title && record.title.trim()) {
      return record.title.trim();
    }
    return String(record.id);
  }

  function buildPopupHtml(record, state = {}) {
    const detailUrl = buildDetailUrl(record.id);
    const displayLabel = getRecordDisplayLabel(record);
    const taxonHtml = (record.taxon && record.taxon.trim())
      ? `<div class="wr-desc"><small class="text-muted">Taxon: ${record.taxon.trim()}</small></div>`
      : '';
    let photosHtml = '';
    if (state.loading) {
      photosHtml = `<div class="text-muted small mt-2 mb-0">${state.loading}</div>`;
    } else if (state.errorMessage) {
      photosHtml = `<div class="text-danger small mt-2 mb-0">${state.errorMessage}</div>`;
    } else if (Array.isArray(record.photos) && record.photos.length) {
      const photosForDisplay = record.photos.slice(0, 2);
      photosHtml = `<div class="wr-photos">${photosForDisplay.map((photoObj, idx) =>
        `<img class="wr-photo-thumb" src="${photoObj.thumb}" alt="Foto ${displayLabel}" loading="lazy" data-full="${photoObj.full}" data-record-id="${record.id}" data-photo-index="${idx}">`
      ).join('')}</div>`;
    } else if (record.has_photos) {
      photosHtml = '<div class="text-muted small mt-2 mb-0">Fotky se načtou po kliknutí na bod.</div>';
    } else {
      photosHtml = '<div class="text-muted small mt-2 mb-0">Bez fotodokumentace</div>';
    }
    const assessButtonClass = record.has_assessment ? 'wr-popup-btn assess has-assessment' : 'wr-popup-btn assess';
    let popupHtml = `
      <div class="wr-popup">
        <div><a href="${detailUrl}" class="wr-title">${displayLabel}</a></div>
        ${taxonHtml}
        ${photosHtml}
        <div class="wr-popup-actions">
          <button type="button" class="wr-popup-btn photo" data-action="capture" data-record-id="${record.id}" title="Vyfotit">
            <i class="bi bi-camera-fill"></i>
          </button>
          <button type="button" class="${assessButtonClass}" data-action="assessment" data-record-id="${record.id}" title="Hodnocení stromu">
            <i class="bi bi-clipboard2-pulse"></i>
          </button>
          <button type="button" class="wr-popup-btn intervention" data-action="intervention" data-record-id="${record.id}" title="Zásahy">
            <i class="bi bi-tools"></i>
          </button>
          <a class="wr-popup-btn edit" href="/tracker/${record.id}/edit/" title="Upravit úkon">
            <i class="bi bi-pencil-square"></i>
          </a>
        </div>
      </div>`;
    return popupHtml;
  }

  function renderTreeDetailHtml(record, state = {}) {
    if (!record) return '';
    const displayLabel = getRecordDisplayLabel(record);
    return `
      <div class="tree-panel-inner">
        <div class="tree-panel-header">
          <span class="tree-panel-title">${displayLabel}</span>
          <button type="button" class="tree-panel-close" aria-label="Zavřít detail stromu">&times;</button>
        </div>
        ${buildPopupHtml(record, state)}
      </div>`;
  }

  function refreshTreePanel(record, stateOverrides = null) {
    if (!treePanel || !record) return;
    if (activeTreePanelRecordId !== Number(record.id)) return;
    const state = stateOverrides || {};
    treePanel.innerHTML = renderTreeDetailHtml(record, state);
    openBottomPanel();
    attachPopupActionHandlers(treePanel);
  }

  function openTreePanel(record, state = {}) {
    if (!treePanel || !record) return;
    activeTreePanelRecordId = Number(record.id);
    treePanel.innerHTML = renderTreeDetailHtml(record, state);
    openBottomPanel();
    attachPopupActionHandlers(treePanel);
    ensureRecordDetails(record);
  }

  function closeTreePanel() {
    if (!treePanel) return;
    treePanel.innerHTML = '';
    closeBottomPanel();
    activeTreePanelRecordId = null;
  }

  function handleMarkerClick(marker) {
    if (!marker) return;
    const record = findRecordById(marker.recordId);
    if (!record) return;
    openTreePanel(record);
  }

  function refreshLabels() {
    const show = labelsEnabled && map.getZoom() >= LABEL_MIN_ZOOM;
    markers.forEach(markerInstance => {
      const tooltip = markerInstance.getTooltip();
      if (!tooltip) return;
      const el = tooltip.getElement();
      if (!el) return;
      if (show) el.classList.remove('wr-label-hidden');
      else el.classList.add('wr-label-hidden');
      if (labelSize === 'large') {
        el.style.fontSize = '13px';
      } else {
        el.style.fontSize = '11px';
      }
    });
  }

  map.on('zoomend', refreshLabels);

  if (labelsCheckbox) {
    labelsCheckbox.addEventListener('change', (e) => {
      labelsEnabled = e.target.checked;
      refreshLabels();
    });
  }
  if (labelSizeSelect) {
    labelSizeSelect.addEventListener('change', (e) => {
      labelSize = e.target.value;
      refreshLabels();
    });
  }

  function updateMarkers(projectId) {
    clusterLayer.clearLayers();
    markers.length = 0;
    records
      .filter(r => {
        if (!projectId) return true;
        if (projectId === 'none') return r.project_id === null;
        return String(r.project_id) === String(projectId);
      })
      .forEach(r => {
        if (r.lat !== null && r.lat !== undefined && r.lon !== null && r.lon !== undefined) {
          const m = L.marker([Number(r.lat), Number(r.lon)], { icon: wrIcon });
          m.recordId = Number(r.id);
          m.on('click', () => handleMarkerClick(m));
          m.bindTooltip(getRecordDisplayLabel(r), {
            direction: 'top',
            permanent: true,
            className: 'wr-label',
            offset: [0, -8]
          });
          clusterLayer.addLayer(m);
          markers.push(m);
        }
      });
    refreshLabels();
  }
  updateMarkers(projectSelect ? projectSelect.value : '');

  function attachPopupActionHandlers(container) {
    if (!container) return;
    container.querySelectorAll('.wr-popup-btn[data-action="capture"]').forEach(btn => {
      btn.addEventListener('click', (ev) => {
        ev.preventDefault();
        ev.stopPropagation();
        triggerPhotoCapture(btn.getAttribute('data-record-id'));
      });
    });
    container.querySelectorAll('.wr-popup-btn[data-action="assessment"]').forEach(btn => {
      btn.addEventListener('click', (ev) => {
        ev.preventDefault();
        ev.stopPropagation();
        openAssessmentForRecord(btn.getAttribute('data-record-id'));
      });
    });
    container.querySelectorAll('.wr-popup-btn[data-action="intervention"]').forEach(btn => {
      btn.addEventListener('click', (ev) => {
        ev.preventDefault();
        ev.stopPropagation();
        openInterventionModal(btn.getAttribute('data-record-id'));
      });
    });
  }

  function ensureRecordDetails(record) {
    if (!record) return;
    const recordId = Number(record.id);
    if (Array.isArray(record.photos)) {
      refreshTreePanel(record);
      return;
    }
    if (detailLoadingRecords.has(recordId)) {
      return;
    }
    detailLoadingRecords.add(recordId);
    refreshTreePanel(record, { loading: 'Načítám fotky…' });
    fetch(detailApiUrlFor(recordId), {
      method: 'GET',
      headers: { 'X-Requested-With': 'XMLHttpRequest' },
    })
      .then(resp => resp.json().then(body => ({ status: resp.status, body })))
      .then(({ status, body }) => {
        if (status >= 400 || !body || body.status !== 'ok' || !body.record) {
          const msg = body && body.msg ? body.msg : 'Nepodařilo se načíst detaily.';
          throw new Error(msg);
        }
        const detail = body.record;
        record.photos = Array.isArray(detail.photos) ? detail.photos : [];
        record.has_photos = !!detail.has_photos;
        record.has_assessment = !!detail.has_assessment;
        refreshTreePanel(record);
      })
      .catch(err => {
        refreshTreePanel(record, { errorMessage: err && err.message ? err.message : 'Nepodařilo se načíst detaily.' });
      })
      .finally(() => {
        detailLoadingRecords.delete(recordId);
      });
  }

  // Deep-link handling
  (function(){
    const rid = paramRecord;
    const proj = paramProject;
    if (proj && projectSelect) {
      projectSelect.value = proj;
      updateMarkers(proj);
    }
    if (rid) {
      activeRecordId = rid;
      updateBackLink(rid);
      const rec = (records || []).find(r => String(r.id) === String(rid));
      if (rec && projectSelect) {
        const desired = (rec.project_id === null) ? 'none' : String(rec.project_id);
        if (String(projectSelect.value) !== desired) {
          projectSelect.value = desired;
          updateMarkers(desired);
        }
      }
      let target = null;
      clusterLayer.eachLayer(layer => { if (layer && Number(layer.recordId) === Number(rid)) target = layer; });
      if (target) {
        clusterLayer.zoomToShowLayer(target, () => { const ll = target.getLatLng(); map.setView(ll, Math.max(map.getZoom(), 18)); handleMarkerClick(target); });
      }
    } else if (proj) {
      let bounds = null;
      clusterLayer.eachLayer(layer => {
        const ll = layer.getLatLng();
        bounds = bounds ? bounds.extend(ll) : L.latLngBounds(ll, ll);
      });
      if (bounds) {
        map.fitBounds(bounds, { padding: [50, 50], maxZoom: 17 });
      }
      updateBackLink(null);
    } else {
      updateBackLink(null);
    }
  })();

  // New work-record modal (create from map)
  function resetNewRecordForm() {
    if (newRecordTitleInput) newRecordTitleInput.value = '';
    if (taxonDisplayInput) taxonDisplayInput.value = '';
    clearTaxonSelection();
    hideTaxonSuggestions();
  }

  function openNewRecordModal() {
    if (!newRecordModal) return;
    resetNewRecordForm();
    newRecordModal.classList.add('active');
  }

  function closeNewRecordModal() {
    if (!newRecordModal) return;
    newRecordModal.classList.remove('active');
  }

  function submitNewRecord() {
    if (!selectedLat || !selectedLon) {
      alert('Nejd��v klikni do mapy a vyber bod.');
      return;
    }
    if (!newRecordSaveBtn) return;

    const title = newRecordTitleInput ? newRecordTitleInput.value.trim() : '';
    const displayTaxon = taxonDisplayInput ? taxonDisplayInput.value.trim() : '';
    const latinTaxon = taxonLatinInput ? taxonLatinInput.value.trim() : '';
    const czechTaxon = taxonCzechInput ? taxonCzechInput.value.trim() : '';
    const gbifKeyValue = taxonGbifKeyInput ? taxonGbifKeyInput.value.trim() : '';
    const taxonValue = latinTaxon || displayTaxon;
    const projectId = projectSelect ? projectSelect.value : '';

    newRecordSaveBtn.disabled = true;
    fetch("{% url 'map_create_work_record' %}", {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: new URLSearchParams({
        title: title,
        taxon: taxonValue,
        taxon_czech: czechTaxon,
        taxon_latin: latinTaxon,
        taxon_gbif_key: gbifKeyValue,
        date: '',
        project_id: (projectId && projectId !== 'none') ? projectId : '',
        latitude: selectedLat,
        longitude: selectedLon,
      }),
    })
    .then(resp => resp.json())
    .then(data => {
      if (data.status === 'ok' && data.record) {
        const rec = data.record;
        records.push({
          id: rec.id,
          title: rec.title || '',
          external_tree_id: rec.external_tree_id || '',
          taxon: rec.taxon || '',
          taxon_czech: rec.taxon_czech || '',
          taxon_latin: rec.taxon_latin || '',
          taxon_gbif_key: rec.taxon_gbif_key,
          project: rec.project || '',
          project_id: rec.project_id,
          lat: rec.lat,
          lon: rec.lon,
          photos: [],
          has_assessment: false,
          has_photos: false,
        });
        recordsForSelect.push({
          id: rec.id,
          title: rec.title || '',
          external_tree_id: rec.external_tree_id || '',
          taxon: rec.taxon || '',
          taxon_czech: rec.taxon_czech || '',
          taxon_latin: rec.taxon_latin || '',
          taxon_gbif_key: rec.taxon_gbif_key,
          project_id: rec.project_id,
          has_coords: true,
        });
        activeRecordId = rec.id;
        updateBackLink(rec.id);
        if (typeof updateMarkers === 'function') {
          updateMarkers(projectSelect ? projectSelect.value : '');
        }
        if (map && typeof map.setView === 'function') {
          map.setView([rec.lat, rec.lon], Math.max(map.getZoom(), 18));
        }
        closeNewRecordModal();

        // Otevřít popup nového bodu (pokud existuje)
        let target = null;
        clusterLayer.eachLayer(layer => {
          if (layer && Number(layer.recordId) === Number(rec.id)) target = layer;
        });
        if (target) {
          clusterLayer.zoomToShowLayer(target, () => { handleMarkerClick(target); });
        }
      } else {
        alert(data.msg || 'Nepodařilo se uložit úkon.');
      }
    })
    .catch(() => {
      alert('Chyba při ukládání úkonu.');
    })
    .finally(() => {
      newRecordSaveBtn.disabled = false;
    });
  }

  if (newRecordCancelBtn) {
    newRecordCancelBtn.addEventListener('click', closeNewRecordModal);
  }
  if (newRecordCloseBtn) {
    newRecordCloseBtn.addEventListener('click', closeNewRecordModal);
  }
  if (newRecordModal) {
    newRecordModal.addEventListener('click', (e) => {
      if (e.target === newRecordModal) closeNewRecordModal();
    });
  }
  if (newRecordSaveBtn) {
    newRecordSaveBtn.addEventListener('click', submitNewRecord);
  }

  if (taxonDisplayInput) {
    taxonDisplayInput.addEventListener('input', () => {
      const value = taxonDisplayInput.value.trim();
      clearTaxonSelection();
      if (value.length < 2) {
        hideTaxonSuggestions();
        return;
      }
      requestTaxonSuggestions(value);
    });
    taxonDisplayInput.addEventListener('focus', () => {
      if (taxonSuggestionsList && taxonSuggestionsList.childElementCount) {
        taxonSuggestionsList.classList.add('visible');
      }
    });
  }

  document.addEventListener('click', (event) => {
    if (taxonFieldWrapper && !taxonFieldWrapper.contains(event.target)) {
      hideTaxonSuggestions();
    }
  });

  // Attach create FAB handler (capture phase to override redirect)
  if (createFab) {
    createFab.addEventListener('click', function(e) {
      if (!selectedLat || !selectedLon) {
        alert('Nejd��v klikni do mapy a vyber bod.');
        return;
      }
      e.preventDefault();
      e.stopImmediatePropagation();
      openNewRecordModal();
    }, true);
  }

  function showAssessmentModal() {
    if (!assessmentModal) return;
    assessmentModal.classList.add('active');
  }

  function hideAssessmentModal() {
    if (!assessmentModal) return;
    assessmentModal.classList.remove('active');
    if (assessmentMessage) {
      assessmentMessage.textContent = '';
      assessmentMessage.className = 'mt-2 small';
    }
  }

  function updateSliderLabel(inputEl, labelEl, scaleKey) {
    if (!inputEl || !labelEl) return;
    const raw = inputEl.value;
    if (!raw) {
      labelEl.textContent = '–';
      return;
    }
    if (scaleKey && assessmentScales && assessmentScales[scaleKey]) {
      const label = assessmentScales[scaleKey][String(raw)];
      if (label) {
        labelEl.textContent = label;
        return;
      }
    }
    labelEl.textContent = raw;
  }

  function updatePerspectiveLabel() {
    if (!assessmentPerspectiveSlider || !assessmentPerspectiveValue) return;
    const letter = perspectiveLetterFromSlider(assessmentPerspectiveSlider.value);
    const label =
      assessmentScales &&
      assessmentScales.perspective &&
      assessmentScales.perspective[letter]
        ? assessmentScales.perspective[letter]
        : perspectiveLabelFromLetter(letter);
    assessmentPerspectiveValue.textContent = label;
  }

  function updateMistletoeLabel() {
    if (!assessmentMistletoe || !assessmentMistletoeValue) return;
    const raw = assessmentMistletoe.value;
    if (raw === '' || raw === null || raw === undefined) {
      assessmentMistletoeValue.textContent = '–';
      return;
    }
    if (String(raw) === '0') {
      assessmentMistletoeValue.textContent = 'bez jmelí';
      return;
    }
    const info = mistletoeScales ? mistletoeScales[String(raw)] : null;
    if (!info) {
      assessmentMistletoeValue.textContent = raw;
      return;
    }
    const code = info.code ? info.code + ' – ' : '';
    assessmentMistletoeValue.textContent =
      code + info.label + ' (' + info.range + ' objemu koruny)';
  }

  const stemRowLocks = new WeakMap();

  function parseStemNumber(value) {
    if (value === null || value === undefined) return null;
    const normalized = String(value).trim().replace(',', '.');
    if (!normalized) return null;
    const parsed = parseFloat(normalized);
    if (!Number.isFinite(parsed) || parsed <= 0) return null;
    return parsed;
  }

  function roundStemInt(value) {
    if (!Number.isFinite(value)) return null;
    const rounded = Math.round(value);
    if (rounded <= 0) return null;
    return rounded;
  }

  function parseStemInt(value) {
    const numberVal = parseStemNumber(value);
    if (numberVal === null) return null;
    return roundStemInt(numberVal);
  }

  function parseStemList(value) {
    if (!value) return [];
    if (Array.isArray(value)) {
      return value
        .map(parseStemInt)
        .filter(item => item !== null);
    }
    return String(value)
      .split(',')
      .map(part => parseStemInt(part))
      .filter(item => item !== null);
  }

  function stemRowLock(rowEl, locked) {
    if (locked === undefined) return !!stemRowLocks.get(rowEl);
    stemRowLocks.set(rowEl, locked);
  }

  function setRowValues(rowEl, diameter, circumference) {
    const diameterInput = rowEl.querySelector('.stem-diameter-input');
    const circumferenceInput = rowEl.querySelector('.stem-circumference-input');
    if (diameterInput) diameterInput.value = diameter !== null ? String(diameter) : '';
    if (circumferenceInput) circumferenceInput.value = circumference !== null ? String(circumference) : '';
  }

  function syncRowFromInput(rowEl, source) {
    if (!rowEl || stemRowLock(rowEl)) return;
    const diameterInput = rowEl.querySelector('.stem-diameter-input');
    const circumferenceInput = rowEl.querySelector('.stem-circumference-input');
    if (!diameterInput || !circumferenceInput) return;
    const diameterNum = parseStemNumber(diameterInput.value);
    const circumferenceNum = parseStemNumber(circumferenceInput.value);
    stemRowLock(rowEl, true);
    if (source === 'diameter' && diameterNum !== null) {
      const computed = roundStemInt(Math.PI * diameterNum);
      if (computed !== null) circumferenceInput.value = String(computed);
    } else if (source === 'circumference' && circumferenceNum !== null) {
      const computed = roundStemInt(circumferenceNum / Math.PI);
      if (computed !== null) diameterInput.value = String(computed);
    }
    stemRowLock(rowEl, false);
  }

  function updateStemLists() {
    if (!stemsList) return;
    const diameterList = [];
    const circumferenceList = [];
    const rows = stemsList.querySelectorAll('.stem-row');
    rows.forEach(rowEl => {
      const diameterInput = rowEl.querySelector('.stem-diameter-input');
      const circumferenceInput = rowEl.querySelector('.stem-circumference-input');
      if (!diameterInput || !circumferenceInput) return;
      const diameterNum = parseStemNumber(diameterInput.value);
      const circumferenceNum = parseStemNumber(circumferenceInput.value);
      if (diameterNum === null && circumferenceNum === null) return;
      let diameterVal = diameterNum !== null ? roundStemInt(diameterNum) : null;
      let circumferenceVal = circumferenceNum !== null ? roundStemInt(circumferenceNum) : null;
      if (diameterVal === null && circumferenceVal !== null) {
        diameterVal = roundStemInt(circumferenceVal / Math.PI);
      } else if (circumferenceVal === null && diameterVal !== null) {
        circumferenceVal = roundStemInt(Math.PI * diameterVal);
      }
      if (diameterVal === null || circumferenceVal === null) return;
      diameterList.push(diameterVal);
      circumferenceList.push(circumferenceVal);
    });

    if (assessmentStemDiametersListHidden) {
      assessmentStemDiametersListHidden.value = diameterList.join(',');
    }
    if (assessmentStemCircumferencesListHidden) {
      assessmentStemCircumferencesListHidden.value = circumferenceList.join(',');
    }

    if (!assessmentStemDiameterHidden || !assessmentStemCircumferenceHidden) return;
    if (!diameterList.length) {
      assessmentStemDiameterHidden.value = '';
      assessmentStemCircumferenceHidden.value = '';
      return;
    }
    let maxIdx = 0;
    for (let i = 1; i < diameterList.length; i += 1) {
      if (diameterList[i] > diameterList[maxIdx]) maxIdx = i;
    }
    assessmentStemDiameterHidden.value = String(diameterList[maxIdx]);
    assessmentStemCircumferenceHidden.value = String(circumferenceList[maxIdx]);
  }

  function createStemRow(diameter, circumference) {
    if (!stemsList) return null;
    const rowEl = document.createElement('div');
    rowEl.className = 'stem-row d-flex gap-2 align-items-end';
    rowEl.innerHTML =
      '<div class="flex-grow-1">' +
      '<label class="form-label mb-1 small" for="">Průměr (cm)</label>' +
      '<input type="number" step="1" inputmode="numeric" class="form-control form-control-sm stem-diameter-input" placeholder="např. 30">' +
      '</div>' +
      '<div class="flex-grow-1">' +
      '<label class="form-label mb-1 small" for="">Obvod (cm)</label>' +
      '<input type="number" step="1" inputmode="numeric" class="form-control form-control-sm stem-circumference-input" placeholder="např. 94">' +
      '</div>' +
      '<button type="button" class="btn btn-outline-danger btn-sm stem-remove-btn" aria-label="Smazat kmen">&times;</button>';
    const diameterInput = rowEl.querySelector('.stem-diameter-input');
    const circumferenceInput = rowEl.querySelector('.stem-circumference-input');
    const removeBtn = rowEl.querySelector('.stem-remove-btn');
    if (diameterInput) {
      diameterInput.addEventListener('input', () => {
        syncRowFromInput(rowEl, 'diameter');
        updateStemLists();
      });
      diameterInput.addEventListener('blur', () => {
        const numberVal = parseStemNumber(diameterInput.value);
        if (numberVal === null) return;
        const rounded = roundStemInt(numberVal);
        if (rounded === null) return;
        diameterInput.value = String(rounded);
        if (!parseStemNumber(circumferenceInput.value)) {
          const computed = roundStemInt(Math.PI * rounded);
          if (computed !== null) circumferenceInput.value = String(computed);
        }
        updateStemLists();
      });
    }
    if (circumferenceInput) {
      circumferenceInput.addEventListener('input', () => {
        syncRowFromInput(rowEl, 'circumference');
        updateStemLists();
      });
      circumferenceInput.addEventListener('blur', () => {
        const numberVal = parseStemNumber(circumferenceInput.value);
        if (numberVal === null) return;
        const rounded = roundStemInt(numberVal);
        if (rounded === null) return;
        circumferenceInput.value = String(rounded);
        if (!parseStemNumber(diameterInput.value)) {
          const computed = roundStemInt(rounded / Math.PI);
          if (computed !== null) diameterInput.value = String(computed);
        }
        updateStemLists();
      });
    }
    if (removeBtn) {
      removeBtn.addEventListener('click', () => {
        rowEl.remove();
        updateStemLists();
      });
    }
    stemsList.appendChild(rowEl);
    setRowValues(rowEl, diameter, circumference);
    return rowEl;
  }

  function clearStemRows() {
    if (!stemsList) return;
    stemsList.innerHTML = '';
  }

  function initStemRowsFromData(data) {
    clearStemRows();
    const diameters = parseStemList(data && data.stem_diameters_cm_list);
    const circumferences = parseStemList(data && data.stem_circumferences_cm_list);
    if (diameters.length || circumferences.length) {
      const length = Math.max(diameters.length, circumferences.length);
      for (let i = 0; i < length; i += 1) {
        const d = i < diameters.length ? diameters[i] : null;
        const c = i < circumferences.length ? circumferences[i] : null;
        createStemRow(d, c);
      }
      updateStemLists();
      return;
    }
    const fallbackDiameter = parseStemInt(data && data.dbh_cm);
    const fallbackCirc = parseStemInt(data && data.stem_circumference_cm);
    if (fallbackDiameter !== null || fallbackCirc !== null) {
      let diameterVal = fallbackDiameter;
      let circumferenceVal = fallbackCirc;
      if (diameterVal === null && circumferenceVal !== null) {
        diameterVal = Math.round(circumferenceVal / Math.PI);
      } else if (circumferenceVal === null && diameterVal !== null) {
        circumferenceVal = Math.round(Math.PI * diameterVal);
      }
      createStemRow(diameterVal, circumferenceVal);
      updateStemLists();
      return;
    }
    createStemRow(null, null);
    updateStemLists();
  }

  function updateCrownAreaHint(areaValue, widthValue, heightValue) {
    if (assessmentCrownAreaInput) {
      assessmentCrownAreaInput.value = areaValue || "";
    }
    if (!assessmentCrownAreaHint) return;
    if (areaValue) {
      assessmentCrownAreaHint.textContent = "";
      return;
    }
    const widthNum = typeof widthValue === "number" ? widthValue : parseFloat(widthValue);
    const heightNum = typeof heightValue === "number" ? heightValue : parseFloat(heightValue);
    if (!heightNum || heightNum <= 0) {
      assessmentCrownAreaHint.textContent = "Chybí výška stromu";
      return;
    }
    if (!widthNum || widthNum <= 0) {
      assessmentCrownAreaHint.textContent = "Zadej šířku koruny";
      return;
    }
    assessmentCrownAreaHint.textContent = "";
  }

  function updateCrownAreaHintFromInputs() {
    const widthVal = assessmentCrownWidthInput ? assessmentCrownWidthInput.value : null;
    const heightVal = assessmentHeightInput ? assessmentHeightInput.value : null;
    const areaVal = assessmentCrownAreaInput ? assessmentCrownAreaInput.value : null;
    updateCrownAreaHint(areaVal, widthVal, heightVal);
  }

  function perspectiveLetterFromSlider(val) {
    const n = Number(val);
    if (n === 1) return 'a';
    if (n === 2) return 'b';
    if (n === 3) return 'c';
    return null;
  }

  function perspectiveLabelFromLetter(letter) {
    if (letter === 'a') return 'a – dlouhodobě perspektivní';
    if (letter === 'b') return 'b – krátkodobě perspektivní';
    if (letter === 'c') return 'c – neperspektivní';
    return '(nenastaveno)';
  }

  function perspectiveSliderValueFromLetter(letter) {
    if (letter === 'a') return 1;
    if (letter === 'b') return 2;
    if (letter === 'c') return 3;
    return 1;
  }

  function showInterventionModal() {
    if (!interventionModal) return;
    interventionModal.classList.add('active');
  }

  function hideInterventionModal() {
    if (!interventionModal) return;
    interventionModal.classList.remove('active');
    setInterventionMessage('', true);
  }

  function updateInterventionNoteHint() {
    if (!interventionNoteHintModal || !interventionTypeSelect) return;
    const data = interventionNoteData?.[interventionTypeSelect.value];
    if (data && data.note_required) {
      interventionNoteHintModal.textContent = data.note_hint || 'Vyžaduje doplnění poznámky.';
    } else {
      interventionNoteHintModal.textContent = '';
    }
  }

  function buildInterventionApiUrl(recordId) {
    if (!interventionApiTemplate) return interventionForm ? interventionForm.action : '';
    return interventionApiTemplate.replace('/0/', `/${recordId}/`);
  }

  function renderInterventionList(items) {
    if (!interventionListContainer) return;
    if (!items || !items.length) {
      interventionListContainer.innerHTML = '<p class="text-muted mb-1">Zatím nejsou zadány žádné zásahy.</p>';
      return;
    }
    let html = '';
    html += '<div class="mb-1"><strong>Existující zásahy</strong></div>';
    html += '<div><table class="table table-sm mb-1"><thead><tr>';
    html += '<th>Kód</th><th>Název</th><th>Stav</th><th>Vytvořeno</th><th></th>';
    html += '</tr></thead><tbody>';
    items.forEach(item => {
      const created = item.created_at || '';
      const handed = item.handed_over_for_check_at || null;
      let label = '';
      if (handed) {
        label = 'Předáno ke kontrole';
      } else if (created) {
        label = 'Vytvořeno';
      }
      html += '<tr>';
      html += `<td>${item.code || ''}</td>`;
      html += `<td>${item.name || ''}</td>`;
      html += `<td>${item.status || ''}</td>`;
      html += '<td>';
      if (label || created || handed) {
        const ts = handed || created;
        html += '<div class="small text-muted">';
        if (label) {
          html += `${label}: `;
        }
        html += ts ? new Date(ts).toLocaleString('cs-CZ') : '-';
        html += '</div>';
      } else {
        html += '<span class="text-muted">-</span>';
      }
      html += '</td>';
      html += '<td class="text-end">';
      if (item.status_code === 'approved' || item.status_code === 'in_progress') {
        html += `<button type="button" class="btn btn-outline-secondary btn-sm" data-action="handover" data-intervention-id="${item.id}" title="Předat ke kontrole"><i class="bi bi-send-check"></i></button>`;
      }
      html += '</td>';
      html += '</tr>';
    });
    html += '</tbody></table></div>';
    interventionListContainer.innerHTML = html;
  }

  function loadInterventionsForRecord(recordId) {
    if (!interventionModal || !interventionForm || !recordId) return;
    if (!interventionListContainer) return;
    const url = buildInterventionApiUrl(recordId);
    if (!url) return;
    interventionListContainer.innerHTML = '<p class="text-muted mb-1">Načítám zásahy…</p>';
    fetch(url, {
      method: 'GET',
      headers: { 'X-Requested-With': 'XMLHttpRequest' },
    })
      .then(resp => (resp.ok ? resp.json() : Promise.reject()))
      .then(body => {
        if (!body || body.status !== 'ok') return;
        renderInterventionList(body.interventions || []);
      })
      .catch(() => {
        interventionListContainer.innerHTML = '<p class="text-danger mb-1">Nepodařilo se načíst zásahy.</p>';
      });
  }

  function handoverIntervention(recordId, interventionId, buttonEl) {
    const url = buildInterventionApiUrl(recordId);
    if (!url) return;
    const payload = new URLSearchParams();
    payload.set('action', 'handover');
    payload.set('id', String(interventionId));
    if (buttonEl) {
      buttonEl.disabled = true;
    }
    fetch(url, {
      method: 'POST',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: payload.toString(),
    })
      .then(resp => resp.json().then(body => ({ status: resp.status, body })))
      .then(({ status, body }) => {
        if (status >= 400 || !body || body.status !== 'ok') {
          throw body;
        }
        if (recordId) {
          loadInterventionsForRecord(recordId);
        }
      })
      .catch(() => {
        setInterventionMessage('Nepodařilo se předat zásah ke kontrole.', true);
      })
      .finally(() => {
        if (buttonEl) {
          buttonEl.disabled = false;
        }
      });
  }

  function setInterventionMessage(text, isError = true) {
    if (!interventionFormErrors) return;
    interventionFormErrors.textContent = text;
    interventionFormErrors.className = isError
      ? 'mt-2 text-danger small'
      : 'mt-2 text-success small';
  }

  function formatInterventionErrors(errors) {
    const parts = [];
    for (const key in errors) {
      const items = errors[key] || [];
      items.forEach(item => {
        if (item.message) {
          parts.push(item.message);
        }
      });
    }
    return parts.join(' ');
  }

  function openInterventionModal(recordId) {
    if (!interventionModal || !interventionForm) return;
    interventionForm.reset();
    if (interventionTreeIdInput) {
      interventionTreeIdInput.value = recordId;
    }
    const actionUrl = buildInterventionApiUrl(recordId);
    if (actionUrl) {
      interventionForm.action = actionUrl;
    }
    updateInterventionNoteHint();
    setInterventionMessage('', true);
    if (recordId) {
      loadInterventionsForRecord(recordId);
    }
    showInterventionModal();
  }

  function submitInterventionForm(event) {
    if (event) {
      event.preventDefault();
    }
    if (!interventionForm) return;
    const action = interventionForm.action;
    const payload = new FormData(interventionForm);
    if (interventionTreeIdInput) {
      payload.set('tree_id', interventionTreeIdInput.value);
    }
    if (interventionSaveBtn) {
      interventionSaveBtn.disabled = true;
    }
    fetch(action, {
      method: 'POST',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
      },
      body: payload,
    })
      .then(resp => resp.json().then(body => ({ status: resp.status, body })))
      .then(({ status, body }) => {
        if (status >= 400 || body.status !== 'ok') {
          throw body;
        }
        const recordId = interventionTreeIdInput ? interventionTreeIdInput.value : null;
        if (interventionForm) {
          interventionForm.reset();
          if (interventionTreeIdInput && recordId) {
            interventionTreeIdInput.value = recordId;
          }
        }
        setInterventionMessage('Zásah byl uložen.', false);
        if (recordId) {
          loadInterventionsForRecord(recordId);
        }
      })
      .catch(err => {
        if (err && err.errors) {
          setInterventionMessage(formatInterventionErrors(err.errors), true);
        } else if (err && err.msg) {
          setInterventionMessage(err.msg, true);
        } else {
          setInterventionMessage('Nepodařilo se uložit zásah.', true);
        }
      })
      .finally(() => {
        if (interventionSaveBtn) {
          interventionSaveBtn.disabled = false;
        }
      });
  }

  if (assessmentModal) {
    try {
      assessmentScales = JSON.parse(assessmentModal.dataset.assessmentScales || '{}');
    } catch (e) {
      assessmentScales = {};
    }
    try {
      mistletoeScales = JSON.parse(assessmentModal.dataset.mistletoeScales || '{}');
    } catch (e) {
      mistletoeScales = {};
    }
  }

  [assessmentPhysAge, assessmentVitality, assessmentHealth, assessmentStability].forEach((inputEl, idx) => {
    if (!inputEl) return;
    const labelMap = [assessmentPhysAgeValue, assessmentVitalityValue, assessmentHealthValue, assessmentStabilityValue];
    const labelEl = labelMap[idx];
    const scaleKeys = ['physiological_age', 'vitality', 'health_state', 'stability'];
    inputEl.addEventListener('input', () => updateSliderLabel(inputEl, labelEl, scaleKeys[idx]));
  });
  if (assessmentMistletoe) {
    assessmentMistletoe.addEventListener('input', updateMistletoeLabel);
  }

  if (stemAddBtn) {
    stemAddBtn.addEventListener('click', () => {
      createStemRow(null, null);
      updateStemLists();
    });
  }

  if (assessmentCrownWidthInput) {
    assessmentCrownWidthInput.addEventListener("input", updateCrownAreaHintFromInputs);
  }
  if (assessmentHeightInput) {
    assessmentHeightInput.addEventListener("input", updateCrownAreaHintFromInputs);
  }

  if (assessmentPerspectiveSlider && assessmentPerspectiveValue) {
    assessmentPerspectiveSlider.addEventListener('input', updatePerspectiveLabel);
  }

  function openAssessmentForRecord(recordId) {
    if (!assessmentModal) return;

    if (assessmentWorkRecordIdInput) assessmentWorkRecordIdInput.value = recordId;
    initStemRowsFromData(null);
    if (assessmentHeightInput) assessmentHeightInput.value = '';
    if (assessmentCrownWidthInput) assessmentCrownWidthInput.value = "";
    if (assessmentCrownAreaInput) assessmentCrownAreaInput.value = "";
    if (assessmentCrownAreaHint) assessmentCrownAreaHint.textContent = "";
    if (assessmentPhysAge) assessmentPhysAge.value = 3;
    if (assessmentVitality) assessmentVitality.value = 3;
    if (assessmentHealth) assessmentHealth.value = 3;
    if (assessmentStability) assessmentStability.value = 3;
    if (assessmentMistletoe) assessmentMistletoe.value = 0;
    if (assessmentPerspectiveSlider) {
      assessmentPerspectiveSlider.value = 1;
    }
    updateSliderLabel(assessmentPhysAge, assessmentPhysAgeValue, 'physiological_age');
    updateSliderLabel(assessmentVitality, assessmentVitalityValue, 'vitality');
    updateSliderLabel(assessmentHealth, assessmentHealthValue, 'health_state');
    updateSliderLabel(assessmentStability, assessmentStabilityValue, 'stability');
    updateMistletoeLabel();
    updatePerspectiveLabel();
    updateCrownAreaHintFromInputs();
    if (assessmentMessage) {
      assessmentMessage.textContent = '';
      assessmentMessage.className = 'mt-2 small';
    }

    showAssessmentModal();

    const url = `${assessmentApiBase}${recordId}/assessment/`;
    fetch(url, {
      method: 'GET',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
      },
    })
      .then(resp => {
        if (!resp.ok) throw new Error('Failed to load assessment');
        return resp.json();
      })
      .then(data => {
        initStemRowsFromData(data);
        if (assessmentHeightInput && data.height_m !== null && data.height_m !== undefined) {
          assessmentHeightInput.value = data.height_m;
        }
        if (assessmentCrownWidthInput && data.crown_width_m !== null && data.crown_width_m !== undefined) {
          assessmentCrownWidthInput.value = data.crown_width_m;
        }
        if (assessmentCrownAreaInput && data.crown_area_m2 !== null && data.crown_area_m2 !== undefined) {
          assessmentCrownAreaInput.value = data.crown_area_m2;
        }
        if (assessmentPhysAge && data.physiological_age) {
          assessmentPhysAge.value = data.physiological_age;
        }
        if (assessmentVitality && data.vitality) {
          assessmentVitality.value = data.vitality;
        }
        if (assessmentHealth && data.health_state) {
          assessmentHealth.value = data.health_state;
        }
        if (assessmentStability && data.stability) {
          assessmentStability.value = data.stability;
        }
        if (assessmentMistletoe) {
          assessmentMistletoe.value = data.mistletoe_level ? data.mistletoe_level : 0;
        }
        if (assessmentPerspectiveSlider && assessmentPerspectiveValue && data.perspective) {
          const letter = data.perspective;
          assessmentPerspectiveSlider.value = perspectiveSliderValueFromLetter(letter);
        }

        updateSliderLabel(assessmentPhysAge, assessmentPhysAgeValue, 'physiological_age');
        updateSliderLabel(assessmentVitality, assessmentVitalityValue, 'vitality');
        updateSliderLabel(assessmentHealth, assessmentHealthValue, 'health_state');
        updateSliderLabel(assessmentStability, assessmentStabilityValue, 'stability');
        updateMistletoeLabel();
        updatePerspectiveLabel();
        updateCrownAreaHintFromInputs();
      })
      .catch(err => {
        console.error(err);
        if (assessmentMessage) {
          assessmentMessage.textContent = 'Nepodařilo se načíst hodnocení.';
          assessmentMessage.className = 'mt-2 small text-danger';
        }
      });
  }

  // Photo viewer handlers
  let currentAlbum = [];
  let currentPhotoIndex = 0;
  let captureFile = null;
  let captureRecordId = null;

  function showPhoto(index) {
    if (!photoViewer || !photoViewerImg || !currentAlbum.length) return;
    if (index < 0 || index >= currentAlbum.length) return;
    currentPhotoIndex = index;
    const photo = currentAlbum[currentPhotoIndex];
    photoViewerImg.src = photo.full;
    photoViewer.classList.add('active');
  }

  function openPhotoViewer(recordId, photoIndex) {
    const rec = (records || []).find(r => Number(r.id) === Number(recordId));
    if (!rec || !Array.isArray(rec.photos) || !rec.photos.length) return;
    currentAlbum = rec.photos;
    showPhoto(photoIndex);
  }

  function closePhotoViewer() {
    if (!photoViewer) return;
    photoViewer.classList.remove('active');
  }

  if (photoViewer) {
    photoViewer.addEventListener('click', (e) => {
      if (e.target === photoViewer) closePhotoViewer();
    });
    if (photoViewerClose) photoViewerClose.addEventListener('click', closePhotoViewer);
    if (photoViewerPrev) photoViewerPrev.addEventListener('click', (e) => {
      e.stopPropagation();
      showPhoto((currentPhotoIndex - 1 + currentAlbum.length) % currentAlbum.length);
    });
    if (photoViewerNext) photoViewerNext.addEventListener('click', (e) => {
      e.stopPropagation();
      showPhoto((currentPhotoIndex + 1) % currentAlbum.length);
    });
    document.addEventListener('keydown', (e) => {
      if (!photoViewer.classList.contains('active')) return;
      if (e.key === 'Escape') closePhotoViewer();
      if (e.key === 'ArrowRight') showPhoto((currentPhotoIndex + 1) % currentAlbum.length);
      if (e.key === 'ArrowLeft') showPhoto((currentPhotoIndex - 1 + currentAlbum.length) % currentAlbum.length);
    });
  }

  function toggleCommentField() {
    if (!captureCommentWrap) return;
    captureCommentWrap.classList.toggle('show');
  }

  function openCaptureModal() {
    if (!photoCaptureModal) return;
    photoCaptureModal.classList.add('active');
  }

  function resetCaptureState() {
    captureFile = null;
    captureRecordId = null;
    if (photoCaptureInput) photoCaptureInput.value = '';
    if (captureCommentInput) captureCommentInput.value = '';
    if (captureCommentWrap) captureCommentWrap.classList.remove('show');
    if (capturePreview) capturePreview.src = '';
  }

  function closeCaptureModal() {
    if (!photoCaptureModal) return;
    photoCaptureModal.classList.remove('active');
    resetCaptureState();
  }

  function triggerPhotoCapture(recordId) {
    const rid = recordId || activeRecordId;
    if (!rid) {
      alert('Nejdřív otevři mapu z detailu úkonu.');
      return;
    }
    captureRecordId = rid;
    if (photoCaptureInput) {
      photoCaptureInput.value = '';
      photoCaptureInput.click();
    }
  }

  function uploadCapturedPhoto() {
    if (!captureFile || !captureRecordId) {
      alert('Chybí fotka nebo úkon.');
      return;
    }
    if (!captureSaveBtn) return;
    const formData = new FormData();
    const baseComment = captureCommentInput ? captureCommentInput.value.trim() : '';
    const todayStr = new Date().toLocaleDateString('cs-CZ');
    const finalComment = baseComment ? `${todayStr} – ${baseComment}` : todayStr;
    formData.append('record_id', captureRecordId);
    formData.append('photo', captureFile);
    formData.append('comment', finalComment);
    captureSaveBtn.disabled = true;
    fetch("{% url 'map_upload_photo' %}", {
      method: 'POST',
      headers: { 'X-CSRFToken': '{{ csrf_token }}' },
      body: formData,
    })
    .then(resp => resp.json())
    .then(data => {
      if (data.status === 'ok' && data.photo) {
        const rec = (records || []).find(r => Number(r.id) === Number(captureRecordId));
        if (rec) {
          if (!Array.isArray(rec.photos)) rec.photos = [];
          rec.photos.unshift(data.photo);
          rec.has_photos = true;
          refreshTreePanel(rec);
        }
        closeCaptureModal();
        updateMarkers(projectSelect ? projectSelect.value : '');
        // znovu otevřít popup pro daný úkon
        let target = null;
        clusterLayer.eachLayer(layer => {
          if (layer && Number(layer.recordId) === Number(captureRecordId)) target = layer;
        });
        if (target) {
          clusterLayer.zoomToShowLayer(target, () => { handleMarkerClick(target); });
        }
      } else {
        alert(data.msg || 'Nepodařilo se uložit fotku.');
      }
    })
    .catch(() => alert('Chyba při ukládání fotky.'))
    .finally(() => {
      captureSaveBtn.disabled = false;
    });
  }

  if (photoCaptureInput) {
    photoCaptureInput.addEventListener('change', async (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      try {
        await setCompressedFileToInput(photoCaptureInput, file, capturePreview);
        const compressed = photoCaptureInput.files && photoCaptureInput.files[0];
        if (!compressed) return;
        captureFile = compressed;
        openCaptureModal();
      } catch (err) {
        console.error('Compression failed', err);
        captureFile = file;
        const reader = new FileReader();
        reader.onload = ev => {
          if (capturePreview) capturePreview.src = ev.target.result;
          openCaptureModal();
        };
        reader.readAsDataURL(file);
      }
    });
  }

  if (captureCommentToggle) {
    captureCommentToggle.addEventListener('click', toggleCommentField);
  }
  if (captureCancelBtn) {
    captureCancelBtn.addEventListener('click', closeCaptureModal);
  }
  if (captureSaveBtn) {
    captureSaveBtn.addEventListener('click', uploadCapturedPhoto);
  }
  if (photoCaptureModal) {
    photoCaptureModal.addEventListener('click', (e) => {
      if (e.target === photoCaptureModal) closeCaptureModal();
    });
  }

  if (assessmentCancelBtn) {
    assessmentCancelBtn.addEventListener('click', hideAssessmentModal);
  }
  if (assessmentCloseBtn) {
    assessmentCloseBtn.addEventListener('click', hideAssessmentModal);
  }
  if (assessmentModal) {
    assessmentModal.addEventListener('click', (e) => {
      if (e.target === assessmentModal) hideAssessmentModal();
    });
  }

  if (interventionCancelBtn) {
    interventionCancelBtn.addEventListener('click', hideInterventionModal);
  }
  if (interventionCloseBtn) {
    interventionCloseBtn.addEventListener('click', hideInterventionModal);
  }
  if (interventionModal) {
    interventionModal.addEventListener('click', (e) => {
      if (e.target === interventionModal) hideInterventionModal();
    });
  }
  if (interventionForm) {
    interventionForm.addEventListener('submit', submitInterventionForm);
    if (interventionTypeSelect) {
      interventionTypeSelect.addEventListener('change', updateInterventionNoteHint);
    }
  }
  if (interventionListContainer) {
    interventionListContainer.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-action="handover"]');
      if (!btn) return;
      e.preventDefault();
      const recordId = interventionTreeIdInput ? interventionTreeIdInput.value : null;
      const interventionId = btn.getAttribute('data-intervention-id');
      if (!recordId || !interventionId) return;
      handoverIntervention(recordId, interventionId, btn);
    });
  }

  if (assessmentSaveBtn) {
    assessmentSaveBtn.addEventListener('click', () => {
      const recordId = assessmentWorkRecordIdInput ? assessmentWorkRecordIdInput.value : null;
      if (!recordId) {
        alert('Chybí ID úkonu.');
        return;
      }
      const url = `${assessmentApiBase}${recordId}/assessment/`;
      const payload = {
        dbh_cm: assessmentStemDiameterHidden && assessmentStemDiameterHidden.value ? assessmentStemDiameterHidden.value : null,
        stem_circumference_cm: assessmentStemCircumferenceHidden && assessmentStemCircumferenceHidden.value ? assessmentStemCircumferenceHidden.value : null,
        stem_diameters_cm_list: assessmentStemDiametersListHidden && assessmentStemDiametersListHidden.value ? assessmentStemDiametersListHidden.value : '',
        stem_circumferences_cm_list: assessmentStemCircumferencesListHidden && assessmentStemCircumferencesListHidden.value ? assessmentStemCircumferencesListHidden.value : '',
        height_m: assessmentHeightInput && assessmentHeightInput.value ? assessmentHeightInput.value : null,
        crown_width_m: assessmentCrownWidthInput && assessmentCrownWidthInput.value ? assessmentCrownWidthInput.value : null,
        physiological_age: assessmentPhysAge && assessmentPhysAge.value ? assessmentPhysAge.value : null,
        vitality: assessmentVitality && assessmentVitality.value ? assessmentVitality.value : null,
        health_state: assessmentHealth && assessmentHealth.value ? assessmentHealth.value : null,
        stability: assessmentStability && assessmentStability.value ? assessmentStability.value : null,
        mistletoe_level: assessmentMistletoe && assessmentMistletoe.value !== ''
          ? assessmentMistletoe.value
          : null,
        perspective: assessmentPerspectiveSlider
          ? perspectiveLetterFromSlider(assessmentPerspectiveSlider.value)
          : null,
      };

      assessmentSaveBtn.disabled = true;
      fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}',
          'X-Requested-With': 'XMLHttpRequest',
        },
        body: JSON.stringify(payload),
      })
        .then(resp => {
          if (!resp.ok) throw new Error('Save failed');
          return resp.json();
        })
        .then(() => {
          const recIdNum = Number(recordId);
          const rec = (records || []).find(r => Number(r.id) === recIdNum);
          if (rec) {
            rec.has_assessment = true;
          }
          document
            .querySelectorAll('.wr-popup-btn.assess[data-record-id="' + recordId + '"]')
            .forEach(btn => btn.classList.add('has-assessment'));
          hideAssessmentModal();
        })
        .catch(err => {
          console.error(err);
          if (assessmentMessage) {
            assessmentMessage.textContent = 'Chyba při ukládání hodnocení.';
            assessmentMessage.className = 'mt-2 small text-danger';
          }
        })
        .finally(() => {
          assessmentSaveBtn.disabled = false;
        });
    });
  }

  document.addEventListener('click', (event) => {
    const target = event.target.closest('.wr-photo-thumb');
    if (!target) return;
    event.preventDefault();
    const recordId = target.getAttribute('data-record-id');
    const index = Number(target.getAttribute('data-photo-index')) || 0;
    openPhotoViewer(recordId, index);
  }, true);

  // Required Mapy.cz logo
  const LogoControl = L.Control.extend({
    options: { position: 'bottomleft' },
    onAdd: function () {
      const container = L.DomUtil.create('div');
      const link = L.DomUtil.create('a', '', container);
      link.href = 'http://mapy.com/';
      link.target = '_blank';
      link.innerHTML = '<img src="https://api.mapy.com/img/api/logo.svg" width="100px" />';
      L.DomEvent.disableClickPropagation(link);
      return container;
    },
  });
  new LogoControl().addTo(map);

});
</script>
{% endblock %}
