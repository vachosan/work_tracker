{% extends "tracker/base.html" %}
{% block title %}Test ‚Äì mapa a ulo≈æen√≠ sou≈ôadnic{% endblock %}
{% block content %}
<div class="container py-3">
  <h5>üìç Test ‚Äì v√Ωbƒõr stromu a ulo≈æen√≠ sou≈ôadnic</h5>
  <p class="text-muted small">
    Mapa se p≈ôibl√≠≈æ√≠ podle tv√© polohy (pokud ji prohl√≠≈æeƒç dovol√≠). Klikni na mapu pro oznaƒçen√≠ stromu a ulo≈æ sou≈ôadnice k √∫konu.
  </p>
  <div class="d-flex gap-2 mb-2">
    <a href="{% url 'work_record_list' %}" class="btn btn-outline-secondary btn-sm">
      <i class="bi bi-list-ul"></i> Zpƒõt na seznam
    </a>
    <a id="backDetailLink" href="#" class="btn btn-outline-primary btn-sm d-none">
      <i class="bi bi-arrow-left-circle"></i> Zpƒõt na detail
    </a>
  </div>

  <!-- V√Ωbƒõr √∫konu -->
  <label for="recordSelect" class="form-label">Vyber √∫kon (strom):</label>
  <select id="recordSelect" class="form-select mb-3">
  {% for record in work_records %}
    <option value="{{ record.id }}">
      #{{ record.id }} ‚Äì {{ record.title|default:"(bez n√°zvu)" }}
      {% if record.description %} ‚Ä¢ {{ record.description|truncatechars:60 }}{% endif %}
      {% if record.project %} ‚Ä¢ {{ record.project.name }}{% endif %}
    </option>
  {% endfor %}
</select>

  <!-- Project select -->
  <label for="projectSelect" class="form-label">Vyber projekt:</label>
  <select id="projectSelect" class="form-select mb-3">
    <option value="">Vsechny projekty</option>
    <option value="none">Bez projektu</option>
    {% for p in projects %}
      <option value="{{ p.id }}">{{ p.name }}</option>
    {% endfor %}
  </select>

  <!-- Mapa -->
  <div id="map" style="width:100%; height:400px; border-radius:10px;"></div>

  <div class="mt-3 small text-muted" id="coordsInfo">Klikni na mapu pro v√Ωbƒõr bodu.</div>

  <!-- Tlaƒç√≠tko pro ulo≈æen√≠ -->
  <button id="saveBtn" class="btn btn-success mt-2" disabled>üíæ Ulo≈æit polohu</button>
</div>

<!-- Leaflet knihovna -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.2/dist/leaflet.css"
/>
<script src="https://unpkg.com/leaflet@1.9.2/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css">
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
{{ records_for_select|json_script:"records-data" }}
{{ records_with_coords|json_script:"coords-data" }}
{{ projects_js|json_script:"projects-data" }}



<script>
document.addEventListener("DOMContentLoaded", function () {
  const API_KEY = "{{ mapy_key }}";
  // jednotn√Ω styl pro body (zelen√© koleƒçko)
  const circleStyle = { color: "#2ecc71", fillColor: "#2ecc71", fillOpacity: 0.9, radius: 6, weight: 1 };
  const wrIcon = L.divIcon({ className: 'wr-dot', iconSize: [12,12] });

  // populate second select (records) based on selected project
  const recordsForSelect = JSON.parse(document.getElementById('records-data').textContent);
  const projectSelect = document.getElementById('projectSelect');
  const recordSelect = document.getElementById('recordSelect');
  const projectLabel = document.querySelector('label[for="projectSelect"]');
  const recordLabel = document.querySelector('label[for="recordSelect"]');
  const backDetailLink = document.getElementById('backDetailLink');

  function updateBackLink(rid) {
    const id = rid || (recordSelect ? recordSelect.value : null);
    if (!backDetailLink) return;
    if (id) {
      backDetailLink.href = `/tracker/${id}/`;
      backDetailLink.classList.remove('d-none');
    } else {
      backDetailLink.classList.add('d-none');
    }
  }

  // move project selector above record selector
  if (projectLabel && projectSelect && recordLabel && recordLabel.parentNode) {
    recordLabel.parentNode.insertBefore(projectLabel, recordLabel);
    recordLabel.parentNode.insertBefore(projectSelect, recordLabel);
  }

  function populateRecordSelect(projectId) {
    const prev = recordSelect.value;
    recordSelect.innerHTML = '';
    const filtered = recordsForSelect.filter(r => {
      if (!projectId) return true; // all
      if (projectId === 'none') return !r.project_id; // no project
      return String(r.project_id) === String(projectId);
    });
    filtered.forEach(r => {
      const opt = document.createElement('option');
      opt.value = r.id;
      const base = (r.title && r.title.trim()) ? r.title : '(bez nazvu)';
      opt.textContent = r.has_coords ? `${base} \u{1F4CD}` : base; // add üìç if has coords
      recordSelect.appendChild(opt);
    });
    if (prev) {
      const match = Array.from(recordSelect.options).find(o => o.value === prev);
      if (match) recordSelect.value = prev;
    }
    updateBackLink();
  }

  if (projectSelect) {
    projectSelect.addEventListener('change', (e) => { populateRecordSelect(e.target.value); if (typeof updateMarkers === 'function') updateMarkers(e.target.value); });
    populateRecordSelect(projectSelect.value);
  }

  if (recordSelect) {
    recordSelect.addEventListener('change', () => updateBackLink(recordSelect.value));
  }

  // v√Ωchoz√≠ centrum
  const savedView = (()=>{ try { return JSON.parse(localStorage.getItem("wt_map_view")); } catch(e){ return null } })();
  const map = L.map("map");
  if (savedView && Array.isArray(savedView.center) && typeof savedView.zoom === "number") {
    map.setView(savedView.center, savedView.zoom);
  } else {
    map.setView([49.83465, 18.28204], 15);
  }
  map.on('moveend zoomend', () => {
    const c = map.getCenter();
    localStorage.setItem('wt_map_view', JSON.stringify({ center: [c.lat, c.lng], zoom: map.getZoom() }));
  });

  // vrstvy Mapy.cz
  const basic = L.tileLayer(
    `https://api.mapy.com/v1/maptiles/basic/256/{z}/{x}/{y}?apikey=${API_KEY}`,
    { attribution: '&copy; <a href="https://mapy.cz/">Seznam.cz a.s.</a>' }
  ).addTo(map);

  const aerial = L.tileLayer(
    `https://api.mapy.com/v1/maptiles/aerial/256/{z}/{x}/{y}?apikey=${API_KEY}`,
    { attribution: '&copy; <a href="https://mapy.cz/">Seznam.cz a.s.</a>' }
  );

  const hybrid = L.tileLayer(
    `https://api.mapy.com/v1/maptiles/hybrid/256/{z}/{x}/{y}?apikey=${API_KEY}`,
    { attribution: '&copy; <a href="https://mapy.cz/">Seznam.cz a.s.</a>' }
  );

  // p≈ôep√≠naƒç vrstev
  L.control.layers(
    { "Z√°kladn√≠": basic, "Ortofoto": aerial, "Hybridn√≠": hybrid }
  ).addTo(map);

  // p≈ôibli≈æn√° poloha u≈æivatele (modr√Ω punt√≠k)
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        map.setView([lat, lon], 18);
        L.circle([lat, lon], { radius: 5, color: "blue", fillOpacity: 0.6 })
          .addTo(map)
          .bindPopup("Tvoje p≈ôibli≈æn√° poloha")
          .openPopup();
      },
      err => {
        console.warn("GPS nedostupn√°:", err);
      },
      { enableHighAccuracy: true, timeout: 4000 }
    );
  }

  // kliknut√≠ na mapu ‚Üí marker + sou≈ôadnice
  let selectedLat = null;
  let selectedLon = null;
  let marker = null;

  map.on("click", function (e) {
    const { lat, lng } = e.latlng;
    selectedLat = lat.toFixed(7);
    selectedLon = lng.toFixed(7);

    if (marker) map.removeLayer(marker);
    marker = L.circleMarker([lat, lng], circleStyle).addTo(map).bindPopup("Zvolen√Ω strom").openPopup();

    document.getElementById("coordsInfo").innerText = `Lat: ${selectedLat}, Lon: ${selectedLon}`;
    document.getElementById("saveBtn").disabled = false;
  });

  // odesl√°n√≠ sou≈ôadnic AJAXem
  document.getElementById("saveBtn").addEventListener("click", function () {
    const recordId = document.getElementById("recordSelect").value;
    if (!selectedLat || !selectedLon) return alert("Nejd≈ô√≠v klikni do mapy.");
    fetch("{% url 'save_coordinates' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: new URLSearchParams({
        record_id: recordId,
        latitude: selectedLat,
        longitude: selectedLon
      })
    })
      .then(resp => resp.json())
      .then(data => {
  if (data.status === "ok") {
    const recIdNum = Number(recordId);
    const projectsData = JSON.parse(document.getElementById("projects-data").textContent);
    const recInfo = recordsForSelect.find(r => Number(r.id) === recIdNum);
    if (recInfo) { recInfo.has_coords = true; }
    const selOpt = Array.from(recordSelect.options).find(o => Number(o.value) === recIdNum);
    if (selOpt) {
      const base = recInfo && recInfo.title && recInfo.title.trim() ? recInfo.title : "(bez nazvu)";
      if (!/\u{1F4CD}$/.test(selOpt.textContent)) selOpt.textContent = `${base} \u{1F4CD}`;
    }
    const existing = records.find(r => Number(r.id) === recIdNum);
    const projName = (recInfo && recInfo.project_id)
      ? ((projectsData.find(p => Number(p.id) === Number(recInfo.project_id)) || {}).name || "")
      : "";
    if (existing) {
      existing.lat = Number(selectedLat);
      existing.lon = Number(selectedLon);
      existing.project = projName;
      existing.project_id = recInfo ? recInfo.project_id : null;
    } else {
      records.push({ id: recIdNum, title: recInfo && recInfo.title ? recInfo.title : "(bez nazvu)", description: "", project: projName, project_id: recInfo ? recInfo.project_id : null, lat: Number(selectedLat), lon: Number(selectedLon) });
    }
    if (typeof updateMarkers === "function") updateMarkers(projectSelect ? projectSelect.value : "");
    map.setView([Number(selectedLat), Number(selectedLon)], Math.max(map.getZoom(), 18));
  
  } else {
    alert("Chyba: " + data.msg);
  }
})

      .catch(err => alert("Chyba p≈ôi komunikaci se serverem: " + err));
  });
  // vykreslen√≠ v≈°ech existuj√≠c√≠ch √∫kon≈Ø s GPS
let records = JSON.parse(document.getElementById('coords-data').textContent);
const clusterLayer = L.markerClusterGroup({
  disableClusteringAtZoom: 17,
  spiderfyOnMaxZoom: true,
  chunkedLoading: true
});
map.addLayer(clusterLayer);
function updateMarkers(projectId) {
  clusterLayer.clearLayers();
  records
    .filter(r => {
      if (!projectId) return true;               // all projects
      if (projectId === 'none') return r.project_id === null; // no project
      return String(r.project_id) === String(projectId);
    })
    .forEach(r => {
      if (r.lat && r.lon) {
        const m = L.marker([r.lat, r.lon], { icon: wrIcon });
        m.recordId = Number(r.id);
                const titleText = (r.title && r.title.trim()) ? r.title : '(bez nazvu)';
        const detailUrl = `/tracker/${r.id}/`;
        let popupHtml = `
          <div class="wr-popup">
            <div><a href="${detailUrl}" class="wr-title">${titleText}</a></div>
            ${r.project ? `<div class="text-muted"><small>${r.project}</small></div>` : ''}
            ${r.description ? `<div class="wr-desc">${r.description}</div>` : ''}
            <div class="wr-links"><a class="keep-mapy" href="https://mapy.cz/zakladni?x=${r.lon}&y=${r.lat}&z=18" target="_blank" rel="noopener">Mapy.cz</a></div>
          </div>
        `;
        m.bindPopup(popupHtml);
        clusterLayer.addLayer(m);
      }
    });
}
updateMarkers(projectSelect ? projectSelect.value : '');

// Deep-link handling: focus record and/or set project from URL
(function(){
  const params = new URLSearchParams(window.location.search);
  const rid = params.get('record');
  const proj = params.get('project');
  if (proj && projectSelect) {
    projectSelect.value = proj;
    populateRecordSelect(proj);
    updateMarkers(proj);
  }
  if (rid) {
    if (recordSelect) recordSelect.value = rid;
    const rec = (records || []).find(r => String(r.id) === String(rid));
    if (rec) {
      const desired = (rec.project_id === null) ? 'none' : String(rec.project_id);
      if (projectSelect && String(projectSelect.value) !== desired) {
        projectSelect.value = desired;
        populateRecordSelect(desired);
        updateMarkers(desired);
      }
    }
    let target = null;
    clusterLayer.eachLayer(layer => { if (layer && Number(layer.recordId) === Number(rid)) target = layer; });
    if (target) {
      clusterLayer.zoomToShowLayer(target, () => { const ll = target.getLatLng(); map.setView(ll, Math.max(map.getZoom(), 18)); target.openPopup(); });
    }
  }
})();

  // logo Mapy.com (povinn√©)
  const LogoControl = L.Control.extend({
    options: { position: "bottomleft" },
    onAdd: function () {
      const container = L.DomUtil.create("div");
      const link = L.DomUtil.create("a", "", container);
      link.href = "http://mapy.com/";
      link.target = "_blank";
      link.innerHTML =
        '<img src="https://api.mapy.com/img/api/logo.svg" width="100px" />';
      L.DomEvent.disableClickPropagation(link);
      return container;
    },
  });
  new LogoControl().addTo(map);
});
</script>
{% endblock %}









