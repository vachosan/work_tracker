{% extends "tracker/base.html" %}
{% block title %}Test ‚Äì mapa a ulo≈æen√≠ sou≈ôadnic{% endblock %}
{% block content %}
<div class="container py-3">
  <h5>üìç Test ‚Äì v√Ωbƒõr stromu a ulo≈æen√≠ sou≈ôadnic</h5>
  <p class="text-muted small">
    Mapa se p≈ôibl√≠≈æ√≠ podle tv√© polohy (pokud ji prohl√≠≈æeƒç dovol√≠). Klikni na mapu pro oznaƒçen√≠ stromu a ulo≈æ sou≈ôadnice k √∫konu.
  </p>

  <!-- V√Ωbƒõr √∫konu -->
  <label for="recordSelect" class="form-label">Vyber √∫kon (strom):</label>
  <select id="recordSelect" class="form-select mb-3">
  {% for record in work_records %}
    <option value="{{ record.id }}">
      #{{ record.id }} ‚Äì {{ record.title|default:"(bez n√°zvu)" }}
      {% if record.description %} ‚Ä¢ {{ record.description|truncatechars:60 }}{% endif %}
      {% if record.project %} ‚Ä¢ {{ record.project.name }}{% endif %}
    </option>
  {% endfor %}
</select>

  <!-- Mapa -->
  <div id="map" style="width:100%; height:400px; border-radius:10px;"></div>

  <div class="mt-3 small text-muted" id="coordsInfo">Klikni na mapu pro v√Ωbƒõr bodu.</div>

  <!-- Tlaƒç√≠tko pro ulo≈æen√≠ -->
  <button id="saveBtn" class="btn btn-success mt-2" disabled>üíæ Ulo≈æit polohu</button>
</div>

<!-- Leaflet knihovna -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.2/dist/leaflet.css"
/>
<script src="https://unpkg.com/leaflet@1.9.2/dist/leaflet.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const API_KEY = "{{ mapy_key }}";

  // v√Ωchoz√≠ centrum
  const map = L.map("map").setView([49.83465, 18.28204], 15);

  // vrstvy Mapy.cz
  const basic = L.tileLayer(
    `https://api.mapy.com/v1/maptiles/basic/256/{z}/{x}/{y}?apikey=${API_KEY}`,
    { attribution: '&copy; <a href="https://mapy.cz/">Seznam.cz a.s.</a>' }
  ).addTo(map);

  const aerial = L.tileLayer(
    `https://api.mapy.com/v1/maptiles/aerial/256/{z}/{x}/{y}?apikey=${API_KEY}`,
    { attribution: '&copy; <a href="https://mapy.cz/">Seznam.cz a.s.</a>' }
  );

  const hybrid = L.tileLayer(
    `https://api.mapy.com/v1/maptiles/hybrid/256/{z}/{x}/{y}?apikey=${API_KEY}`,
    { attribution: '&copy; <a href="https://mapy.cz/">Seznam.cz a.s.</a>' }
  );

  // p≈ôep√≠naƒç vrstev
  L.control.layers(
    { "Z√°kladn√≠": basic, "Ortofoto": aerial, "Hybridn√≠": hybrid }
  ).addTo(map);

  // p≈ôibli≈æn√° poloha u≈æivatele (modr√Ω punt√≠k)
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        map.setView([lat, lon], 18);
        L.circle([lat, lon], { radius: 5, color: "blue", fillOpacity: 0.6 })
          .addTo(map)
          .bindPopup("Tvoje p≈ôibli≈æn√° poloha")
          .openPopup();
      },
      err => {
        console.warn("GPS nedostupn√°:", err);
      },
      { enableHighAccuracy: true, timeout: 4000 }
    );
  }

  // kliknut√≠ na mapu ‚Üí marker + sou≈ôadnice
  let selectedLat = null;
  let selectedLon = null;
  let marker = null;

  map.on("click", function (e) {
    const { lat, lng } = e.latlng;
    selectedLat = lat.toFixed(7);
    selectedLon = lng.toFixed(7);

    if (marker) map.removeLayer(marker);
    marker = L.marker([lat, lng]).addTo(map).bindPopup("Zvolen√Ω strom").openPopup();

    document.getElementById("coordsInfo").innerText = `Lat: ${selectedLat}, Lon: ${selectedLon}`;
    document.getElementById("saveBtn").disabled = false;
  });

  // odesl√°n√≠ sou≈ôadnic AJAXem
  document.getElementById("saveBtn").addEventListener("click", function () {
    const recordId = document.getElementById("recordSelect").value;
    if (!selectedLat || !selectedLon) return alert("Nejd≈ô√≠v klikni do mapy.");
    fetch("{% url 'save_coordinates' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: new URLSearchParams({
        record_id: recordId,
        latitude: selectedLat,
        longitude: selectedLon
      })
    })
      .then(resp => resp.json())
      .then(data => {
  if (data.status === "ok") {
    alert("Sou≈ôadnice byly ulo≈æeny.");

    // üü¢ P≈ôidej zelen√© zv√Ωraznƒõn√≠ aktu√°ln√≠ho bodu
    L.circle([selectedLat, selectedLon], {
      color: "green",
      radius: 6,
      fillOpacity: 0.8
    }).addTo(map).bindPopup("Ulo≈æen√Ω strom").openPopup();

  } else {
    alert("Chyba: " + data.msg);
  }
})

      .catch(err => alert("Chyba p≈ôi komunikaci se serverem: " + err));
  });
  // vykreslen√≠ v≈°ech existuj√≠c√≠ch √∫kon≈Ø s GPS
const records = {{ records_with_coords|safe }};
records.forEach(r => {
  if (r.lat && r.lon) {
    const marker = L.marker([r.lat, r.lon]).addTo(map);
    let popupHtml = `<b>${r.title}</b>`;
    if (r.project) popupHtml += `<br><small>${r.project}</small>`;
    if (r.description) popupHtml += `<br>${r.description}`;
    popupHtml += `<br><a href="https://mapy.cz/zakladni?x=${r.lon}&y=${r.lat}&z=18" target="_blank">üìç Otev≈ô√≠t v Mapy.cz</a>`;
    marker.bindPopup(popupHtml);
  }
});
  // logo Mapy.com (povinn√©)
  const LogoControl = L.Control.extend({
    options: { position: "bottomleft" },
    onAdd: function () {
      const container = L.DomUtil.create("div");
      const link = L.DomUtil.create("a", "", container);
      link.href = "http://mapy.com/";
      link.target = "_blank";
      link.innerHTML =
        '<img src="https://api.mapy.com/img/api/logo.svg" width="100px" />';
      L.DomEvent.disableClickPropagation(link);
      return container;
    },
  });
  new LogoControl().addTo(map);
});
</script>
{% endblock %}
