{% load tracker_extras %}
<!-- Minimal header overlay -->
<div id="map-mini-header">
  <a id="mapBackLink" href="{% url 'work_record_list' %}" class="map-mini-link" aria-label="Zpět">
    <i class="bi bi-arrow-left"></i> Zpět
  </a>
  {% if request.GET.project %}
    <a id="mapProjectTitle" class="map-project-title" data-default-title="Mapa" href="{% url 'project_detail' request.GET.project %}">Mapa</a>
  {% else %}
    <div id="mapProjectTitle" class="map-project-title" data-default-title="Mapa">Mapa</div>
  {% endif %}
  <button id="mapMenuButton" class="map-menu-button" type="button" aria-label="Otevřít nastavení" aria-expanded="false">
    <i class="bi bi-list"></i>
  </button>
</div>

<div id="moveLocationBanner" class="map-move-banner" aria-hidden="true">
  <div class="map-move-banner__text">Klikni do mapy na nové místo</div>
  <div id="moveLocationMessage" class="map-move-banner__message"></div>
  <div class="map-move-banner__actions">
    <button id="moveLocationCancelBtn" type="button" class="btn btn-outline-secondary btn-sm">Zrušit</button>
    <button id="moveLocationSaveBtn" type="button" class="btn btn-primary btn-sm" disabled>Uložit</button>
  </div>
</div>

<!-- Floating action buttons (bottom-right) -->
<div id="map-fabs" class="d-flex flex-column align-items-end gap-2">
  {% if show_save_fab|default:True %}
    <!-- Save-location FAB (hidden in MapLibre pilot). -->
    <button id="saveFab" class="btn btn-success rounded-circle shadow fab-btn" type="button" title="Uložit polohu" aria-label="Uložit polohu" disabled>
      <i class="bi bi-check-lg"></i>
    </button>
  {% endif %}
  <div class="d-flex align-items-center gap-2">
    <div id="hedgeDrawFabGroup" class="d-none d-flex align-items-center gap-1">
      <button id="hedgeDrawFinishBtn" class="btn btn-success btn-sm shadow" type="button" title="Dokončit živý plot" aria-label="Dokončit živý plot">✅</button>
      <button id="hedgeDrawUndoBtn" class="btn btn-outline-light btn-sm shadow" type="button" title="Undo bod" aria-label="Undo bod">↶</button>
      <button id="hedgeDrawCancelBtn" class="btn btn-outline-secondary btn-sm shadow" type="button" title="Zrušit kreslení" aria-label="Zrušit kreslení">✖</button>
    </div>
    <button id="createFab" class="btn btn-primary rounded-circle shadow fab-btn" type="button" title="Přidat záznam" aria-label="Přidat záznam">
      <i class="bi bi-plus-lg"></i>
    </button>
  </div>
</div>

<div id="bottom-panel">
  <div id="tree-panel" class="tree-panel"></div>
  <div id="workrecord-panel-actions" class="tree-panel-actions"></div>
</div>

<!-- Photo viewer overlay -->
<div id="photoViewer">
  <button class="pv-btn pv-close" type="button">&times;</button>
  <button class="pv-btn pv-prev" type="button">&#8249;</button>
  <img src="" alt="Photo preview">
  <button class="pv-btn pv-next" type="button">&#8250;</button>
</div>

<!-- Hidden input for photo capture -->
<input type="file" id="photoCaptureInput" accept="image/*" capture="environment" class="d-none">

<!-- Capture modal -->
<div id="photoCaptureModal" class="capture-modal">
  <div class="capture-card">
    <img id="capturePreview" src="" alt="Nová fotka">
    <div class="capture-actions">
      <button id="captureCommentToggle" type="button" class="btn btn-outline-light btn-sm">Přidat komentář</button>
      <div class="btn-group">
        <button id="captureSaveBtn" type="button" class="btn btn-warning btn-sm">Uložit fotku</button>
        <button id="captureCancelBtn" type="button" class="btn btn-secondary btn-sm">Zrušit</button>
      </div>
    </div>
    <div id="captureCommentWrap" class="collapse mt-2">
      <textarea id="captureCommentInput" class="form-control" rows="2" placeholder="Krátký komentář"></textarea>
    </div>
  </div>
</div>

<div
  id="assessmentModal"
  class="capture-modal assessment-modal"
  data-assessment-scales='{% assessment_scales_json %}'
  data-mistletoe-scales='{% mistletoe_scales_json %}'
>
  <div class="capture-card assessment-modal-card">
    <div class="d-flex justify-content-between align-items-center mb-1">
      <h6
        class="mb-0"
        id="assessmentTitle"
        data-tree-label="Hodnocení stromu"
        data-shrub-label="Hodnocení keře"
        data-hedge-label="Hodnocení živého plotu"
      >Hodnocení stromu</h6>
      <button type="button" class="btn btn-sm btn-outline-light rounded-circle px-2 py-0" id="assessmentCloseBtn" aria-label="Zavřít">&times;</button>
    </div>

    <div class="assessment-scroll">
      <div class="vstack gap-2 small">
        <input type="hidden" id="assessmentWorkRecordId" />
        <input type="hidden" name="stem_diameter_cm" id="stem_d_cm_hidden">
        <input type="hidden" name="stem_circumference_cm" id="stem_c_cm_hidden">
        <input type="hidden" name="stem_diameters_cm_list" id="stem_diameters_cm_list_hidden">
        <input type="hidden" name="stem_circumferences_cm_list" id="stem_circumferences_cm_list_hidden">

        <div id="treeAssessmentFields">
          <div class="stems-section">
            <div class="d-flex align-items-center justify-content-between mb-1">
              <label class="form-label mb-0">Kmeny</label>
              <button type="button" class="btn btn-outline-light btn-sm stem-add-btn" id="stemAddBtn">+ Přidat kmen</button>
            </div>
            <div id="stems-list" class="vstack gap-2"></div>
          </div>

          <div class="row g-2">
            <div class="col-6">
              <label for="assessmentHeight" class="form-label mb-1">Výška stromu [m]</label>
              <input type="number" step="0.1" class="form-control form-control-sm" id="assessmentHeight" placeholder="např. 18">
            </div>
            <div class="col-6">
              <label for="assessmentCrownWidth" class="form-label mb-1">Šířka koruny [m]</label>
              <input type="number" step="0.01" class="form-control form-control-sm" id="assessmentCrownWidth" placeholder="např. 6.5">
            </div>
          </div>

          <div class="mb-1">
            <label class="form-label mb-1" for="assessmentPhysAge">Fyziologické stáří (1–5)</label>
            <input type="range" min="1" max="5" step="1" id="assessmentPhysAge" class="form-range">
            <div class="text-end"><small>Aktuální: <span id="assessmentPhysAgeValue">–</span></small></div>
          </div>

          <div class="mb-1">
            <label class="form-label mb-1" for="assessmentVitality">Vitalita (1–5)</label>
            <input type="range" min="1" max="5" step="1" id="assessmentVitality" class="form-range">
            <div class="text-end"><small>Aktuální: <span id="assessmentVitalityValue">–</span></small></div>
          </div>

          <div class="mb-1">
            <label class="form-label mb-1" for="assessmentHealth">Zdravotní stav (1–5)</label>
            <input type="range" min="1" max="5" step="1" id="assessmentHealth" class="form-range">
            <div class="text-end"><small>Aktuální: <span id="assessmentHealthValue">–</span></small></div>
          </div>

          <div class="mb-2">
            <label class="form-label mb-1" for="assessmentStability">Stabilita (1–5)</label>
            <input type="range" min="1" max="5" step="1" id="assessmentStability" class="form-range">
            <div class="text-end"><small>Aktuální: <span id="assessmentStabilityValue">–</span></small></div>
          </div>

          <div class="mb-2">
            <label class="form-label mb-1" for="assessmentAccessObstacle">Překážky</label>
            <input type="range" min="0" max="2" step="1" id="assessmentAccessObstacle" class="form-range">
            <div class="text-end"><small>Aktuální: <span id="assessmentAccessObstacleValue">–</span></small></div>
          </div>

          <div class="mb-2">
            <label class="form-label mb-1" for="assessmentPerspectiveSlider">Perspektiva stromu (a–c)</label>
            <input type="range" min="1" max="3" step="1" id="assessmentPerspectiveSlider" class="form-range">
            <div class="text-end">
              <small>Aktuální: <span id="assessmentPerspectiveValue">a – dlouhodobě perspektivní</span></small>
            </div>
          </div>

          <div class="mb-2">
            <label class="form-label mb-1" for="assessmentMistletoe">Zastoupení jmelí (0–5)</label>
            <input type="range" min="0" max="5" step="1" id="assessmentMistletoe" class="form-range">
            <div class="text-end"><small>Aktuální: <span id="assessmentMistletoeValue">–</span></small></div>
          </div>
        </div>

        <div id="shrubAssessmentFields" class="d-none">
          <div class="row g-2">
            <div class="col-6">
              <label for="shrubAssessmentHeight" class="form-label mb-1">Výška keře [m]</label>
              <input type="number" step="0.1" class="form-control form-control-sm" id="shrubAssessmentHeight" placeholder="např. 1.5">
            </div>
            <div class="col-6">
              <label for="shrubAssessmentWidth" class="form-label mb-1">Šířka keře [m]</label>
              <input type="number" step="0.1" class="form-control form-control-sm" id="shrubAssessmentWidth" placeholder="např. 2.0">
            </div>
          </div>

          <div class="mb-1">
            <label class="form-label mb-1" for="shrubAssessmentVitality">Vitalita (1–5)</label>
            <input type="range" min="1" max="5" step="1" id="shrubAssessmentVitality" class="form-range">
            <div class="text-end"><small>Aktuální: <span id="shrubAssessmentVitalityValue">–</span></small></div>
          </div>

          <div class="mb-2">
            <label class="form-label mb-1" for="shrubAssessmentNote">Poznámka</label>
            <textarea id="shrubAssessmentNote" class="form-control form-control-sm" rows="2" placeholder="Poznámka (volitelné)"></textarea>
          </div>
        </div>
      </div>
    </div>

    <div class="capture-actions mt-2">
      <div class="small text-muted">
        Hodnocení se ukládá k vybranému úkonu.
      </div>
      <div class="btn-group">
        <button id="assessmentSaveBtn" type="button" class="btn btn-warning btn-sm">Uložit hodnocení</button>
        <button id="assessmentCancelBtn" type="button" class="btn btn-secondary btn-sm">Zrušit</button>
      </div>
    </div>

    <div id="assessmentMessage" class="mt-2 small"></div>
  </div>
</div>

<div id="interventionModal" class="capture-modal" data-api-template="{% url 'tree_intervention_api' 0 %}">
  <div class="capture-card intervention-modal-card">
    <div class="d-flex justify-content-between align-items-center mb-1">
      <h6 class="mb-0">Zásah na stromě</h6>
      <button type="button" class="btn btn-sm btn-outline-light rounded-circle px-2 py-0" id="interventionCloseBtn" aria-label="Zavřít">&times;</button>
    </div>

    <div class="intervention-scroll">
      <div id="intervention-list" class="mb-2 small table-responsive"></div>

      <form id="interventionForm" method="post" action="{% url 'tree_intervention_api' 0 %}" class="vstack gap-2">
        {% csrf_token %}
        <input type="hidden" name="tree_id" id="interventionTreeId" value="">

        <div class="row g-2">
          <div class="col-12">
            {{ intervention_form.intervention_type.label_tag }}
            {{ intervention_form.intervention_type }}
            <div id="interventionNoteHintModal" class="form-text text-muted"></div>
          </div>
          <div class="col-12">
            <button type="button" class="btn btn-link btn-sm p-0 text-muted" id="interventionDescriptionToggle">
              Přidat popis
            </button>
            <div id="interventionDescriptionWrap" class="collapse mt-1">
              {{ intervention_form.description.label_tag }}
              {{ intervention_form.description }}
            </div>
          </div>
          <div class="col-6">
            {{ intervention_form.urgency.label_tag }}
            {{ intervention_form.urgency }}
          </div>
        </div>

        <div id="interventionFormErrors" class="text-danger small"></div>

        <div class="d-flex justify-content-end gap-2">
          <button type="button" class="btn btn-outline-secondary btn-sm" id="interventionCancelBtn">
            Zrušit
          </button>
          <button type="submit" class="btn btn-primary btn-sm" id="interventionSaveBtn">
            Uložit zásah
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<div id="newRecordModal" class="capture-modal">
  <div class="capture-card">
    <div class="d-flex justify-content-between align-items-center mb-1">
      <h6 class="mb-0">Nový strom</h6>
      <button type="button" class="btn btn-sm btn-outline-light rounded-circle px-2 py-0" id="newRecordCloseBtn" aria-label="Zavřít">&times;</button>
    </div>
    <div class="vstack gap-3">
      <div>
        <label class="form-label mb-1" for="newRecordTitle">Číslo stromu (externí)</label>
        <input type="text" id="newRecordTitle" class="form-control form-control-sm" placeholder="Číslo stromu">
      </div>
      <div id="taxon-field-wrapper" class="taxon-autocomplete position-relative">
        <label class="form-label mb-1" for="taxon_display">Taxon</label>
        <input
          type="text"
          id="taxon_display"
          class="form-control form-control-sm"
          placeholder="Taxon"
          autocomplete="off"
        >
        <ul id="taxon-suggestions" class="taxon-suggestions"></ul>
        <input type="hidden" id="taxon_czech" name="taxon_czech">
        <input type="hidden" id="taxon_latin" name="taxon_latin">
        <input type="hidden" id="taxon_gbif_key" name="taxon_gbif_key">
      </div>
    </div>
    <div class="capture-actions mt-2">
      <div class="small text-muted">
        Souřadnice se převezmou z vybraného bodu v mapě.
      </div>
      <div class="btn-group">
        <button id="newRecordSaveBtn" type="button" class="btn btn-warning btn-sm">Uložit strom</button>
        <button id="newRecordCancelBtn" type="button" class="btn btn-secondary btn-sm">Zrušit</button>
      </div>
    </div>
  </div>
</div>

<!-- Controls panel -->
<div id="mapControlsPanel" class="map-controls-panel" aria-hidden="true">
  <div class="map-controls-body">
    <div class="d-flex flex-column gap-2">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="streetNamesCheckbox" checked>
        <label class="form-check-label small" for="streetNamesCheckbox">
          Zobrazit názvy bodů
        </label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="katastrCheckbox">
        <label class="form-check-label small" for="katastrCheckbox">
          Katastr
        </label>
      </div>
      <div class="d-flex align-items-center gap-2">
        <label class="form-label small mb-0" for="labelSizeSelect">Velikost popisku:</label>
        <select id="labelSizeSelect" class="form-select form-select-sm" style="max-width: 140px;">
          <option value="small" selected>Menší</option>
          <option value="large">Větší</option>
        </select>
      </div>
      <div class="small text-muted">Popisky se zobrazí jen při maximálním přiblížení.</div>
    </div>
  </div>
</div>
