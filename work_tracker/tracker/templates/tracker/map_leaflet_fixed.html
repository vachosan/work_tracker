{% extends "tracker/base.html" %}
{% block title %}Mapa{% endblock %}
{% block content %}
<style>
  html, body { height: 100%; overflow: hidden; }
  body { margin: 0; }
  /* fullscreen map overrides */
  main.container { padding: 0 !important; max-width: none; }
  nav.navbar, footer { display: none; }
  /* map fills viewport */
  #map { position: fixed; inset: 0; z-index: 1; }
  /* locate button (top-left) */
  #map-locate { position: fixed; left: 12px; top: calc(56px + 8px); z-index: 1100; }
  #map-locate .locate-btn {
    width: 40px; height: 40px; display: inline-flex; align-items: center; justify-content: center;
    background: rgba(255,255,255,.7); color: #222; border: 1px solid rgba(0,0,0,.2);
    backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
  }
  #map-locate .locate-btn svg { width: 20px; height: 20px; opacity: .85; }
  #map-locate .locate-btn:hover { background: rgba(255,255,255,.9); }
  #map-locate .locate-btn:active { background: rgba(255,255,255,1); }
  /* translucent top bar */
  #map-topbar {
    position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
    display: flex; align-items: center; justify-content: space-between;
    padding: 8px 12px;
    background: rgba(255,255,255,.85);
    -webkit-backdrop-filter: blur(6px);
    backdrop-filter: blur(6px);
    box-shadow: 0 2px 12px rgba(0,0,0,.1);
  }
  /* floating action buttons */
  #map-fabs { position: fixed; right: 16px; bottom: calc(16px + env(safe-area-inset-bottom)); z-index: 1100; }
  #map-fabs .fab-btn { width: 56px; height: 56px; display: inline-flex; align-items: center; justify-content: center; font-size: 1.25rem; }
  /* marker and leaflet tweaks */
  .wr-dot { width: 12px; height: 12px; background: #2ecc71; border: 2px solid #fff; border-radius: 50%; box-shadow: 0 0 0 1px rgba(0,0,0,.2); }
  .leaflet-control-layers { display: none !important; }
  .leaflet-container { background: #f3f3f3; }
  .wr-popup-wrapper { position: relative; }
  .wr-popup .wr-title { font-weight: 600; text-decoration: none; }
  .wr-popup .wr-desc { margin-top: 4px; }
  .wr-photos {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 4px;
    margin-top: 6px;
  }
  .wr-photos img {
    width: 64px;
    height: 64px;
    object-fit: cover;
    border-radius: 6px;
    border: 1px solid rgba(255,255,255,.6);
    box-shadow: 0 1px 4px rgba(0,0,0,.25);
    cursor: pointer;
  }
  .wr-popup-actions {
    display: flex;
    gap: 10px;
    margin-top: 10px;
  }

  /* lightbox */
  #photoViewer {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.92);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
  }
  #photoViewer.active { display: flex; }
  #photoViewer img {
    max-width: 94vw;
    max-height: 90vh;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,.6);
  }
  .pv-btn {
    position: absolute;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    border: none;
    background: rgba(255,255,255,.95);
    color: #111;
    font-size: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 2px 10px rgba(0,0,0,.4);
  }
  .pv-btn:active { transform: scale(0.95); }
  .pv-close { top: 20px; right: 20px; }
  .pv-prev { left: 20px; top: 50%; transform: translateY(-50%); }
  .pv-next { right: 20px; top: 50%; transform: translateY(-50%); }

  /* capture modal */
  .capture-modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,.8);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2100;
    padding: 16px;
  }
  .capture-modal.active { display: flex; }
  .capture-card {
    background: #1f2227;
    border-radius: 16px;
    padding: 16px;
    width: min(420px, 92vw);
    color: #fff;
    box-shadow: 0 10px 24px rgba(0,0,0,.5);
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  .capture-card img {
    width: 100%;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,.2);
    object-fit: cover;
    max-height: 60vh;
  }
  .capture-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
    justify-content: space-between;
  }
  #captureCommentWrap.collapse {
    display: none;
  }
  #captureCommentWrap.collapse.show {
    display: block;
  }
  #newRecordDescWrap.collapse {
    display: none;
  }
  #newRecordDescWrap.collapse.show {
    display: block;
  }
  .wr-popup-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    text-decoration: none;
    box-shadow: 0 2px 6px rgba(0,0,0,.25);
  }
  .wr-popup-btn img,
  .wr-popup-btn svg,
  .wr-popup-btn i {
    pointer-events: none;
  }
  .wr-popup-btn.photo { background: #ffbf00; }
  .wr-popup-btn.edit { background: #b5c0cc; color: #1f2a33; }
  /* offcanvas styling */
  .offcanvas-top { border-bottom-left-radius: 12px; border-bottom-right-radius: 12px; box-shadow: 0 6px 18px rgba(0,0,0,.15); background: rgba(255,255,255,.98); }
  .offcanvas-header { border-bottom: 1px solid rgba(0,0,0,.05); }
  /* tooltip labels for markers */
  .leaflet-tooltip.wr-label {
    font-size: 11px;
    font-weight: 600;
    color: #052c16;
    background: transparent !important;
    border: none !important;
    box-shadow: none !important;
    padding: 0;
    margin: 0;
    line-height: 1;
    text-shadow:
      -1px 0 #fff,
       1px 0 #fff,
       0 -1px #fff,
       0 1px #fff,
      -1px -1px #fff,
      -1px  1px #fff,
       1px -1px #fff,
       1px  1px #fff;
    pointer-events: none;
    transition: opacity .15s ease;
  }
  .leaflet-tooltip.wr-label::before {
    display: none !important;
  }
  .leaflet-tooltip.wr-label.wr-label-hidden {
    opacity: 0;
    display: none;
  }
</style>

<!-- Fullscreen map -->
<div id="map"></div>

<!-- Top bar overlay -->
<div id="map-topbar">
  <a id="mapBackLink" href="{% url 'work_record_list' %}" class="btn btn-light btn-sm rounded-pill shadow-sm">
    <i class="bi bi-arrow-left"></i> Zpět
  </a>
  <div class="fw-semibold small text-dark">Mapa</div>
  <button class="btn btn-light btn-sm rounded-pill shadow-sm" type="button" data-bs-toggle="offcanvas" data-bs-target="#mapControlsPanel" aria-controls="mapControlsPanel" title="Nastavení">
    <i class="bi bi-sliders"></i>
  </button>
</div>

<!-- Floating action buttons (bottom-right) -->
<div id="map-fabs" class="d-flex flex-column align-items-end gap-2">
  <button id="saveFab" class="btn btn-success rounded-circle shadow fab-btn" type="button" title="Uložit polohu" aria-label="Uložit polohu" disabled>
    <i class="bi bi-check-lg"></i>
  </button>
  <button id="createFab" class="btn btn-primary rounded-circle shadow fab-btn" type="button" title="Přidat záznam" aria-label="Přidat záznam">
    <i class="bi bi-plus-lg"></i>
  </button>
</div>

<!-- Photo viewer overlay -->
<div id="photoViewer">
  <button class="pv-btn pv-close" type="button">&times;</button>
  <button class="pv-btn pv-prev" type="button">&#8249;</button>
  <img src="" alt="Photo preview">
  <button class="pv-btn pv-next" type="button">&#8250;</button>
</div>

<!-- Hidden input for photo capture -->
<input type="file" id="photoCaptureInput" accept="image/*" capture="environment" class="d-none">

<!-- Capture modal -->
<div id="photoCaptureModal" class="capture-modal">
  <div class="capture-card">
    <img id="capturePreview" src="" alt="Nová fotka">
    <div class="capture-actions">
      <button id="captureCommentToggle" type="button" class="btn btn-outline-light btn-sm">Přidat komentář</button>
      <div class="btn-group">
        <button id="captureSaveBtn" type="button" class="btn btn-warning btn-sm">Uložit fotku</button>
        <button id="captureCancelBtn" type="button" class="btn btn-secondary btn-sm">Zrušit</button>
      </div>
    </div>
    <div id="captureCommentWrap" class="collapse mt-2">
      <textarea id="captureCommentInput" class="form-control" rows="2" placeholder="Krátký komentář"></textarea>
    </div>
  </div>
</div>

<!-- Less prominent locate button (bottom-left) -->
<div id="map-locate">
  <button id="locateBtn" class="btn btn-light btn-sm rounded-circle shadow locate-btn" type="button" title="Zaměřit na mou polohu" aria-label="Zaměřit na mou polohu">
    <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
      <circle cx="12" cy="12" r="5" fill="none" stroke="currentColor" stroke-width="2" opacity="0.95" />
      <line x1="12" y1="2" x2="12" y2="6" stroke="currentColor" stroke-width="2" opacity="0.95" />
      <line x1="12" y1="18" x2="12" y2="22" stroke="currentColor" stroke-width="2" opacity="0.95" />
      <line x1="2" y1="12" x2="6" y2="12" stroke="currentColor" stroke-width="2" opacity="0.95" />
      <line x1="18" y1="12" x2="22" y2="12" stroke="currentColor" stroke-width="2" opacity="0.95" />
      <circle cx="12" cy="12" r="1.8" fill="currentColor" opacity="0.95" />
    </svg>
  </button>
</div>

<div id="newRecordModal" class="capture-modal">
  <div class="capture-card">
    <div class="d-flex justify-content-between align-items-center mb-1">
      <h6 class="mb-0">Nový úkon</h6>
      <button type="button" class="btn btn-sm btn-outline-light" id="newRecordCloseBtn">&times;</button>
    </div>
    <div class="vstack gap-2">
      <input type="text" id="newRecordTitle" class="form-control form-control-sm" placeholder="Název úkonu">
      <div class="d-flex gap-2">
        <div class="flex-fill">
          <label class="form-label small mb-1" for="newRecordDate">Datum</label>
          <input type="date" id="newRecordDate" class="form-control form-control-sm">
        </div>
        <div class="flex-fill">
          <label class="form-label small mb-1" for="newRecordProject">Projekt</label>
          <select id="newRecordProject" class="form-select form-select-sm">
            <option value="">Bez projektu</option>
            {% for p in projects %}
              <option value="{{ p.id }}">{{ p.name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div>
        <button class="btn btn-link btn-sm p-0" type="button" id="newRecordToggleDesc">+ Přidat popis</button>
        <div id="newRecordDescWrap" class="collapse mt-1">
          <textarea id="newRecordDescription" class="form-control form-control-sm" rows="2" placeholder="Popis (volitelné)"></textarea>
        </div>
      </div>
    </div>
    <div class="capture-actions mt-2">
      <div class="small text-muted">
        Souřadnice se převezmou z vybraného bodu v mapě.
      </div>
      <div class="btn-group">
        <button id="newRecordSaveBtn" type="button" class="btn btn-warning btn-sm">Uložit úkon</button>
        <button id="newRecordCancelBtn" type="button" class="btn btn-secondary btn-sm">Zrušit</button>
      </div>
    </div>
  </div>
</div>

<!-- Controls offcanvas -->
<div class="offcanvas offcanvas-top" tabindex="-1" id="mapControlsPanel" aria-labelledby="mapControlsLabel" style="height:auto; max-height:75vh;">
  <div class="offcanvas-header py-2">
    <h6 class="offcanvas-title" id="mapControlsLabel">Nastavení a uložení</h6>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Zavřít"></button>
  </div>
  <div class="offcanvas-body">
    <label for="projectSelect" class="form-label">Vyber projekt:</label>
    <select id="projectSelect" class="form-select mb-3">
      <option value="">Všechny projekty</option>
      <option value="none">Bez projektu</option>
      {% for p in projects %}
        <option value="{{ p.id }}">{{ p.name }}</option>
      {% endfor %}
    </select>

    <div class="d-flex flex-column gap-2">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="labelsCheckbox" checked>
        <label class="form-check-label small" for="labelsCheckbox">
          Zobrazit názvy bodů
        </label>
      </div>
      <div class="d-flex align-items-center gap-2">
        <label class="form-label small mb-0" for="labelSizeSelect">Velikost popisku:</label>
        <select id="labelSizeSelect" class="form-select form-select-sm" style="max-width: 140px;">
          <option value="small" selected>Menší</option>
          <option value="large">Větší</option>
        </select>
      </div>
      <div class="small text-muted">Popisky se zobrazí jen při maximálním přiblížení.</div>
    </div>
  </div>
</div>

<!-- Leaflet and plugins -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.2/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.2/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css">
<script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<!-- Data for JS -->
{{ records_for_select|json_script:"records-data" }}
{{ records_with_coords|json_script:"coords-data" }}
{{ projects_js|json_script:"projects-data" }}

<script>
document.addEventListener('DOMContentLoaded', function () {
  const API_KEY = "{{ mapy_key }}";
  const wrIcon = L.divIcon({ className: 'wr-dot', iconSize: [12,12] });

  const recordsForSelect = JSON.parse(document.getElementById('records-data').textContent);
  const projectSelect = document.getElementById('projectSelect');
  const backLink = document.getElementById('mapBackLink');
  const saveFab = document.getElementById('saveFab');
  const createFab = document.getElementById('createFab');
  const locateBtn = document.getElementById('locateBtn');
  const labelsCheckbox = document.getElementById('labelsCheckbox');
  const labelSizeSelect = document.getElementById('labelSizeSelect');
  const photoViewer = document.getElementById('photoViewer');
  const photoViewerImg = photoViewer ? photoViewer.querySelector('img') : null;
  const photoViewerPrev = photoViewer ? photoViewer.querySelector('.pv-prev') : null;
  const photoViewerNext = photoViewer ? photoViewer.querySelector('.pv-next') : null;
  const photoViewerClose = photoViewer ? photoViewer.querySelector('.pv-close') : null;
  const photoCaptureInput = document.getElementById('photoCaptureInput');
  const photoCaptureModal = document.getElementById('photoCaptureModal');
  const capturePreview = document.getElementById('capturePreview');
  const captureCommentToggle = document.getElementById('captureCommentToggle');
  const captureCommentWrap = document.getElementById('captureCommentWrap');
  const captureCommentInput = document.getElementById('captureCommentInput');
  const captureSaveBtn = document.getElementById('captureSaveBtn');
  const captureCancelBtn = document.getElementById('captureCancelBtn');
  const newRecordModal = document.getElementById('newRecordModal');
  const newRecordTitleInput = document.getElementById('newRecordTitle');
  const newRecordDescWrap = document.getElementById('newRecordDescWrap');
  const newRecordDescriptionInput = document.getElementById('newRecordDescription');
  const newRecordSaveBtn = document.getElementById('newRecordSaveBtn');
  const newRecordCancelBtn = document.getElementById('newRecordCancelBtn');
  const newRecordCloseBtn = document.getElementById('newRecordCloseBtn');
  const newRecordToggleDesc = document.getElementById('newRecordToggleDesc');
  const projectParam = new URLSearchParams(window.location.search).get('project');

  function buildReturnParam() {
    return encodeURIComponent(window.location.pathname + window.location.search);
  }

  function buildDetailUrl(recordId) {
    const base = `/tracker/${recordId}/`;
    const params = [];
    if (projectParam) params.push(`project=${encodeURIComponent(projectParam)}`);
    params.push(`return=${buildReturnParam()}`);
    return `${base}?${params.join('&')}`;
  }

  // Deep-link params
  const urlParams = new URLSearchParams(window.location.search);
  const paramRecord = urlParams.get('record');
  const paramProject = urlParams.get('project');
  const paramLocate = urlParams.has('locate');

  // currently selected work record (for saving coordinates)
  let activeRecordId = paramRecord || null;

  function updateBackLink(rid) {
    const id = rid || activeRecordId;
    if (!backLink) return;
    backLink.href = id ? buildDetailUrl(id) : `{% url 'work_record_list' %}`;
  }
  updateBackLink(activeRecordId);

  if (projectSelect) {
    projectSelect.addEventListener('change', () => {
      updateMarkers(projectSelect.value);
    });
  }

  // Map init and saved view
  const savedView = (()=>{ try { return JSON.parse(localStorage.getItem('wt_map_view')); } catch(e){ return null } })();
  const map = L.map('map', { minZoom: 3, maxZoom: 20, zoomControl: false });
  if (savedView && Array.isArray(savedView.center) && typeof savedView.zoom === 'number') {
    map.setView(savedView.center, savedView.zoom);
  } else {
    map.setView([49.83465, 18.28204], 15);
  }
  map.on('moveend zoomend', () => {
    const c = map.getCenter();
    localStorage.setItem('wt_map_view', JSON.stringify({ center: [c.lat, c.lng], zoom: map.getZoom() }));
  });

  // Mapy.cz layer: aerial (orthophoto only)
  const aerial = L.tileLayer(
    `https://api.mapy.com/v1/maptiles/aerial/256/{z}/{x}/{y}?apikey=${API_KEY}`,
    { attribution: '&copy; <a href="https://mapy.cz/">Seznam.cz a.s.</a>', maxZoom: 20, minZoom: 3 }
  ).addTo(map);

  // Transparent labels+boundaries overlay (names-overlay) above orthophoto
  const labelsOverlay = L.tileLayer(
    `https://api.mapy.com/v1/maptiles/names-overlay/256/{z}/{x}/{y}?apikey=${API_KEY}`,
    {
      attribution: '&copy; <a href="https://mapy.cz/">Seznam.cz a.s.</a>',
      maxZoom: 20,
      minZoom: 3,
      zIndex: 2,
      opacity: 1,
      errorTileUrl: 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw=='
    }
  ).addTo(map);

  let myLocationCircle = null;
  const shouldCenterOnUser = paramLocate || (!paramRecord && !paramProject && !savedView);

  // Geolocation
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        if (shouldCenterOnUser) map.setView([lat, lon], 18);
        if (myLocationCircle) { try { map.removeLayer(myLocationCircle); } catch(e){} }
        myLocationCircle = L.circle([lat, lon], {
          radius: 5,
          color: '#007bff',
          fillColor: '#007bff',
          fillOpacity: 0.7,
          weight: 2
        }).addTo(map);
      },
      err => { console.warn('GPS nedostupná:', err); },
      { enableHighAccuracy: true, timeout: 4000 }
    );
  }

  // Manual locate action
  if (locateBtn) {
    locateBtn.addEventListener('click', function() {
      if (!navigator.geolocation) return;
      navigator.geolocation.getCurrentPosition(
        pos => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;
          map.setView([lat, lon], Math.max(map.getZoom(), 18));
          if (myLocationCircle) { try { map.removeLayer(myLocationCircle); } catch(e){} }
          myLocationCircle = L.circle([lat, lon], {
            radius: 5,
            color: '#007bff',
            fillColor: '#007bff',
            fillOpacity: 0.7,
            weight: 2
          }).addTo(map);
        },
        err => { console.warn('GPS nedostupná:', err); },
        { enableHighAccuracy: true, timeout: 4000 }
      );
    });
  }

  // Click to select point
  let selectedLat = null;
  let selectedLon = null;
  let marker = null;
  map.on('click', function (e) {
    const { lat, lng } = e.latlng;
    selectedLat = lat.toFixed(7);
    selectedLon = lng.toFixed(7);
    if (marker) map.removeLayer(marker);
    marker = L.circleMarker([lat, lng], {
      color: '#28a745',
      fillColor: '#28a745',
      fillOpacity: 0.9,
      radius: 7,
      weight: 2
    }).addTo(map);

    if (saveFab) saveFab.disabled = false;
  });

  function handleSave() {
      const recordId = activeRecordId;
      if (!recordId) {
        alert('Chybí ID úkonu. Otevři mapu z detailu úkonu.');
        return;
      }
      if (!selectedLat || !selectedLon) return alert('Nejdřív klikni do mapy.');
      fetch("{% url 'save_coordinates' %}", {
        method: 'POST',
        headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ record_id: recordId, latitude: selectedLat, longitude: selectedLon })
      })
      .then(resp => resp.json())
      .then(data => {
        if (data.status === 'ok') {
          const recIdNum = Number(recordId);
          const recInfo = recordsForSelect.find(r => Number(r.id) === recIdNum);
          if (recInfo) { recInfo.has_coords = true; }
          const existing = records.find(r => Number(r.id) === recIdNum);
          if (existing) {
            existing.lat = Number(selectedLat);
            existing.lon = Number(selectedLon);
            existing.project_id = recInfo ? recInfo.project_id : existing.project_id ?? null;
            existing.project = existing.project ?? (recInfo && recInfo.project_name ? recInfo.project_name : '');
          } else {
            const baseTitle = recInfo && recInfo.title ? recInfo.title : '(bez názvu)';
            records.push({
              id: recIdNum,
              title: baseTitle,
              description: '',
              project: '',
              project_id: recInfo ? recInfo.project_id : null,
              lat: Number(selectedLat),
              lon: Number(selectedLon),
              photos: [],
            });
          }
          if (typeof updateMarkers === 'function') updateMarkers(projectSelect ? projectSelect.value : '');
          map.setView([Number(selectedLat), Number(selectedLon)], Math.max(map.getZoom(), 18));
          window.location.href = buildDetailUrl(recIdNum);
        } else {
          alert('Chyba: ' + data.msg);
        }
      })
      .catch(err => alert('Chyba při komunikaci se serverem: ' + err));
  }

  // Save from floating FAB
  if (saveFab) { saveFab.addEventListener('click', handleSave); }

  // Create new record, prefill selected coordinates via query string
  if (createFab) {
    createFab.addEventListener('click', function() {
      if (!selectedLat || !selectedLon) {
        alert('Nejdřív klikni do mapy a vyber bod.');
        return;
      }
      let url = '/tracker/create/';
      const projVal = projectSelect ? projectSelect.value : '';
      if (projVal && projVal !== 'none') { url += `${projVal}/`; }
      const params = [];
      params.push(`lat=${selectedLat}`);
      params.push(`lon=${selectedLon}`);
      if (params.length) url += `?${params.join('&')}`;
      window.location.href = url;
    });
  }

  // Existing records and clustering
  let records = JSON.parse(document.getElementById('coords-data').textContent)
    .map(r => {
      r.photos = Array.isArray(r.photos) ? r.photos : [];
      return r;
    });
  const clusterLayer = L.markerClusterGroup({ disableClusteringAtZoom: 17, spiderfyOnMaxZoom: true, chunkedLoading: true });
  map.addLayer(clusterLayer);

  const markers = [];
  let labelsEnabled = labelsCheckbox ? labelsCheckbox.checked : true;
  let labelSize = labelSizeSelect ? labelSizeSelect.value : 'small';
  const LABEL_MAX_ZOOM = map.getMaxZoom();
  const LABEL_MIN_ZOOM = Math.max(LABEL_MAX_ZOOM - 1, 0);

  function refreshLabels() {
    const show = labelsEnabled && map.getZoom() >= LABEL_MIN_ZOOM;
    markers.forEach(markerInstance => {
      const tooltip = markerInstance.getTooltip();
      if (!tooltip) return;
      const el = tooltip.getElement();
      if (!el) return;
      if (show) el.classList.remove('wr-label-hidden');
      else el.classList.add('wr-label-hidden');
      if (labelSize === 'large') {
        el.style.fontSize = '13px';
      } else {
        el.style.fontSize = '11px';
      }
    });
  }

  map.on('zoomend', refreshLabels);

  if (labelsCheckbox) {
    labelsCheckbox.addEventListener('change', (e) => {
      labelsEnabled = e.target.checked;
      refreshLabels();
    });
  }
  if (labelSizeSelect) {
    labelSizeSelect.addEventListener('change', (e) => {
      labelSize = e.target.value;
      refreshLabels();
    });
  }

  function updateMarkers(projectId) {
    clusterLayer.clearLayers();
    markers.length = 0;
    records
      .filter(r => {
        if (!projectId) return true;
        if (projectId === 'none') return r.project_id === null;
        return String(r.project_id) === String(projectId);
      })
      .forEach(r => {
        if (r.lat && r.lon) {
          const m = L.marker([r.lat, r.lon], { icon: wrIcon });
          m.recordId = Number(r.id);
          const titleText = (r.display_label && r.display_label.trim())
            ? r.display_label
            : ((r.title && r.title.trim()) ? r.title : '(bez názvu)');
          const detailUrl = buildDetailUrl(r.id);
          const photosForDisplay = Array.isArray(r.photos) ? r.photos.slice(0, 2) : [];
          const photosHtml = photosForDisplay.length
            ? `<div class="wr-photos">${photosForDisplay.map((photoObj, idx) => `<img class="wr-photo-thumb" src="${photoObj.thumb}" alt="Foto ${titleText}" loading="lazy" data-full="${photoObj.full}" data-record-id="${r.id}" data-photo-index="${idx}">`).join('')}</div>`
            : `<div class="text-muted small mt-2 mb-0">Bez fotodokumentace</div>`;
          const popupHtml = `
            <div class="wr-popup">
              <div><a href="${detailUrl}" class="wr-title">${titleText}</a></div>
              ${r.description ? `<div class="wr-desc">${r.description}</div>` : ''}
              ${photosHtml}
              <div class="wr-popup-actions">
                <button type="button" class="wr-popup-btn photo" data-action="capture" data-record-id="${r.id}" title="Vyfotit">
                  <i class="bi bi-camera-fill"></i>
                </button>
                <a class="wr-popup-btn edit" href="/tracker/${r.id}/edit/" title="Upravit úkon">
                  <i class="bi bi-pencil-square"></i>
                </a>
              </div>
            </div>`;
          m.bindPopup(popupHtml);
          m.bindTooltip(titleText, {
            direction: 'top',
            permanent: true,
            className: 'wr-label',
            offset: [0, -8]
          });
          clusterLayer.addLayer(m);
          markers.push(m);
        }
      });
    refreshLabels();
  }
  updateMarkers(projectSelect ? projectSelect.value : '');

  // Deep-link handling
  (function(){
    const rid = paramRecord;
    const proj = paramProject;
    if (proj && projectSelect) {
      projectSelect.value = proj;
      updateMarkers(proj);
    }
    if (rid) {
      activeRecordId = rid;
      updateBackLink(rid);
      const rec = (records || []).find(r => String(r.id) === String(rid));
      if (rec && projectSelect) {
        const desired = (rec.project_id === null) ? 'none' : String(rec.project_id);
        if (String(projectSelect.value) !== desired) {
          projectSelect.value = desired;
          updateMarkers(desired);
        }
      }
      let target = null;
      clusterLayer.eachLayer(layer => { if (layer && Number(layer.recordId) === Number(rid)) target = layer; });
      if (target) {
        clusterLayer.zoomToShowLayer(target, () => { const ll = target.getLatLng(); map.setView(ll, Math.max(map.getZoom(), 18)); target.openPopup(); });
      }
    } else if (proj) {
      let bounds = null;
      clusterLayer.eachLayer(layer => {
        const ll = layer.getLatLng();
        bounds = bounds ? bounds.extend(ll) : L.latLngBounds(ll, ll);
      });
      if (bounds) {
        map.fitBounds(bounds, { padding: [50, 50], maxZoom: 17 });
      }
      updateBackLink(null);
    } else {
      updateBackLink(null);
    }
  })();

  // New work-record modal (create from map)
  function resetNewRecordForm() {
    if (newRecordTitleInput) newRecordTitleInput.value = '';
    if (newRecordDescriptionInput) newRecordDescriptionInput.value = '';
    if (newRecordDescWrap) newRecordDescWrap.classList.remove('show');
  }

  function openNewRecordModal() {
    if (!newRecordModal) return;
    resetNewRecordForm();
    newRecordModal.classList.add('active');
  }

  function closeNewRecordModal() {
    if (!newRecordModal) return;
    newRecordModal.classList.remove('active');
  }

  function submitNewRecord() {
    if (!selectedLat || !selectedLon) {
      alert('Nejd��v klikni do mapy a vyber bod.');
      return;
    }
    if (!newRecordSaveBtn) return;

    const title = newRecordTitleInput ? newRecordTitleInput.value.trim() : '';
    const description = newRecordDescriptionInput ? newRecordDescriptionInput.value.trim() : '';
    const projectId = projectSelect ? projectSelect.value : '';

    newRecordSaveBtn.disabled = true;
    fetch("{% url 'map_create_work_record' %}", {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: new URLSearchParams({
        title: title,
        description: description,
        date: '',
        project_id: (projectId && projectId !== 'none') ? projectId : '',
        latitude: selectedLat,
        longitude: selectedLon,
      }),
    })
    .then(resp => resp.json())
    .then(data => {
      if (data.status === 'ok' && data.record) {
        const rec = data.record;
        records.push({
          id: rec.id,
          title: rec.title || '',
          description: rec.description || '',
          project: rec.project || '',
          project_id: rec.project_id,
          lat: rec.lat,
          lon: rec.lon,
          photos: [],
        });
        recordsForSelect.push({
          id: rec.id,
          title: rec.title || '',
          project_id: rec.project_id,
          has_coords: true,
        });
        activeRecordId = rec.id;
        updateBackLink(rec.id);
        if (typeof updateMarkers === 'function') {
          updateMarkers(projectSelect ? projectSelect.value : '');
        }
        if (map && typeof map.setView === 'function') {
          map.setView([rec.lat, rec.lon], Math.max(map.getZoom(), 18));
        }
        closeNewRecordModal();

        // Otevřít popup nového bodu (pokud existuje)
        let target = null;
        clusterLayer.eachLayer(layer => {
          if (layer && Number(layer.recordId) === Number(rec.id)) target = layer;
        });
        if (target) {
          clusterLayer.zoomToShowLayer(target, () => { target.openPopup(); });
        }
      } else {
        alert(data.msg || 'Nepoda�ilo se ulo�it �kon.');
      }
    })
    .catch(() => {
      alert('Chyba p�i ukl�d�n� �konu.');
    })
    .finally(() => {
      newRecordSaveBtn.disabled = false;
    });
  }

  if (newRecordToggleDesc && newRecordDescWrap) {
    newRecordToggleDesc.addEventListener('click', () => {
      newRecordDescWrap.classList.toggle('show');
    });
  }
  if (newRecordCancelBtn) {
    newRecordCancelBtn.addEventListener('click', closeNewRecordModal);
  }
  if (newRecordCloseBtn) {
    newRecordCloseBtn.addEventListener('click', closeNewRecordModal);
  }
  if (newRecordModal) {
    newRecordModal.addEventListener('click', (e) => {
      if (e.target === newRecordModal) closeNewRecordModal();
    });
  }
  if (newRecordSaveBtn) {
    newRecordSaveBtn.addEventListener('click', submitNewRecord);
  }

  // Attach create FAB handler (capture phase to override redirect)
  if (createFab) {
    createFab.addEventListener('click', function(e) {
      if (!selectedLat || !selectedLon) {
        alert('Nejd��v klikni do mapy a vyber bod.');
        return;
      }
      e.preventDefault();
      e.stopImmediatePropagation();
      openNewRecordModal();
    }, true);
  }

  // Photo viewer handlers
  let currentAlbum = [];
  let currentPhotoIndex = 0;
  let captureFile = null;
  let captureRecordId = null;

  function showPhoto(index) {
    if (!photoViewer || !photoViewerImg || !currentAlbum.length) return;
    if (index < 0 || index >= currentAlbum.length) return;
    currentPhotoIndex = index;
    const photo = currentAlbum[currentPhotoIndex];
    photoViewerImg.src = photo.full;
    photoViewer.classList.add('active');
  }

  function openPhotoViewer(recordId, photoIndex) {
    const rec = (records || []).find(r => Number(r.id) === Number(recordId));
    if (!rec || !Array.isArray(rec.photos) || !rec.photos.length) return;
    currentAlbum = rec.photos;
    showPhoto(photoIndex);
  }

  function closePhotoViewer() {
    if (!photoViewer) return;
    photoViewer.classList.remove('active');
  }

  if (photoViewer) {
    photoViewer.addEventListener('click', (e) => {
      if (e.target === photoViewer) closePhotoViewer();
    });
    if (photoViewerClose) photoViewerClose.addEventListener('click', closePhotoViewer);
    if (photoViewerPrev) photoViewerPrev.addEventListener('click', (e) => {
      e.stopPropagation();
      showPhoto((currentPhotoIndex - 1 + currentAlbum.length) % currentAlbum.length);
    });
    if (photoViewerNext) photoViewerNext.addEventListener('click', (e) => {
      e.stopPropagation();
      showPhoto((currentPhotoIndex + 1) % currentAlbum.length);
    });
    document.addEventListener('keydown', (e) => {
      if (!photoViewer.classList.contains('active')) return;
      if (e.key === 'Escape') closePhotoViewer();
      if (e.key === 'ArrowRight') showPhoto((currentPhotoIndex + 1) % currentAlbum.length);
      if (e.key === 'ArrowLeft') showPhoto((currentPhotoIndex - 1 + currentAlbum.length) % currentAlbum.length);
    });
  }

  function toggleCommentField() {
    if (!captureCommentWrap) return;
    captureCommentWrap.classList.toggle('show');
  }

  function openCaptureModal() {
    if (!photoCaptureModal) return;
    photoCaptureModal.classList.add('active');
  }

  function resetCaptureState() {
    captureFile = null;
    captureRecordId = null;
    if (photoCaptureInput) photoCaptureInput.value = '';
    if (captureCommentInput) captureCommentInput.value = '';
    if (captureCommentWrap) captureCommentWrap.classList.remove('show');
    if (capturePreview) capturePreview.src = '';
  }

  function closeCaptureModal() {
    if (!photoCaptureModal) return;
    photoCaptureModal.classList.remove('active');
    resetCaptureState();
  }

  function triggerPhotoCapture(recordId) {
    const rid = recordId || activeRecordId;
    if (!rid) {
      alert('Nejdřív otevři mapu z detailu úkonu.');
      return;
    }
    captureRecordId = rid;
    if (photoCaptureInput) {
      photoCaptureInput.value = '';
      photoCaptureInput.click();
    }
  }

  function uploadCapturedPhoto() {
    if (!captureFile || !captureRecordId) {
      alert('Chybí fotka nebo úkon.');
      return;
    }
    if (!captureSaveBtn) return;
    const formData = new FormData();
    formData.append('record_id', captureRecordId);
    formData.append('photo', captureFile);
    formData.append('comment', captureCommentInput ? captureCommentInput.value.trim() : '');
    captureSaveBtn.disabled = true;
    fetch("{% url 'map_upload_photo' %}", {
      method: 'POST',
      headers: { 'X-CSRFToken': '{{ csrf_token }}' },
      body: formData,
    })
    .then(resp => resp.json())
    .then(data => {
      if (data.status === 'ok' && data.photo) {
        const rec = (records || []).find(r => Number(r.id) === Number(captureRecordId));
        if (rec) {
          if (!Array.isArray(rec.photos)) rec.photos = [];
          rec.photos.unshift(data.photo);
        }
        closeCaptureModal();
        updateMarkers(projectSelect ? projectSelect.value : '');
      } else {
        alert(data.msg || 'Nepodařilo se uložit fotku.');
      }
    })
    .catch(() => alert('Chyba při ukládání fotky.'))
    .finally(() => {
      captureSaveBtn.disabled = false;
    });
  }

  if (photoCaptureInput) {
    photoCaptureInput.addEventListener('change', (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      captureFile = file;
      const reader = new FileReader();
      reader.onload = ev => {
        if (capturePreview) capturePreview.src = ev.target.result;
        openCaptureModal();
      };
      reader.readAsDataURL(file);
    });
  }

  if (captureCommentToggle) {
    captureCommentToggle.addEventListener('click', toggleCommentField);
  }
  if (captureCancelBtn) {
    captureCancelBtn.addEventListener('click', closeCaptureModal);
  }
  if (captureSaveBtn) {
    captureSaveBtn.addEventListener('click', uploadCapturedPhoto);
  }
  if (photoCaptureModal) {
    photoCaptureModal.addEventListener('click', (e) => {
      if (e.target === photoCaptureModal) closeCaptureModal();
    });
  }

  document.addEventListener('click', (event) => {
    const target = event.target.closest('.wr-photo-thumb');
    if (!target) return;
    event.preventDefault();
    const recordId = target.getAttribute('data-record-id');
    const index = Number(target.getAttribute('data-photo-index')) || 0;
    openPhotoViewer(recordId, index);
  }, true);

  // Required Mapy.cz logo
  const LogoControl = L.Control.extend({
    options: { position: 'bottomleft' },
    onAdd: function () {
      const container = L.DomUtil.create('div');
      const link = L.DomUtil.create('a', '', container);
      link.href = 'http://mapy.com/';
      link.target = '_blank';
      link.innerHTML = '<img src="https://api.mapy.com/img/api/logo.svg" width="100px" />';
      L.DomEvent.disableClickPropagation(link);
      return container;
    },
  });
  new LogoControl().addTo(map);

  map.on('popupopen', (e) => {
    const container = e.popup.getElement();
    if (!container) return;
    container.querySelectorAll('.wr-popup-btn[data-action="capture"]').forEach(btn => {
      btn.addEventListener('click', (ev) => {
        ev.preventDefault();
        ev.stopPropagation();
        triggerPhotoCapture(btn.getAttribute('data-record-id'));
      });
    });
  });
});
</script>
{% endblock %}
