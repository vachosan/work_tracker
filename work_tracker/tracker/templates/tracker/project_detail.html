{% extends 'tracker/base.html' %}
{% block title %}{{ project.name }} – úkony{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
  <div>
    <h1 class="h4 m-0">{{ project.name }} – úkony</h1>
    {% if project.description %}
      <div class="text-muted small">{{ project.description }}</div>
    {% endif %}
  </div>
  <div class="d-flex flex-wrap gap-2">
    <a class="btn btn-outline-secondary btn-sm" href="{% url 'work_record_list' %}#project-{{ project.pk }}">
      <i class="bi bi-arrow-left"></i> Zpět na projekty
    </a>
    {% if is_member %}
      <a href="{% url 'create_work_record_for_project' project.pk %}" class="btn btn-primary btn-sm">
        <i class="bi bi-plus-lg"></i> Přidat strom / úkon
      </a>
    {% endif %}
    {% if is_foreman %}
      <a href="{% url 'edit_project' project.pk %}" class="btn btn-outline-warning btn-sm">
        <i class="bi bi-pencil"></i> Upravit projekt
      </a>
      {% if not project.is_closed %}
        <a href="{% url 'close_project' project.pk %}" class="btn btn-outline-danger btn-sm">
          <i class="bi bi-lock"></i> Uzavřít projekt
        </a>
      {% else %}
        <a href="{% url 'activate_project' project.pk %}" class="btn btn-outline-success btn-sm">
          <i class="bi bi-unlock"></i> Aktivovat projekt
        </a>
      {% endif %}
    {% endif %}
  </div>
</div>

<div class="card border-0 shadow-sm mb-3">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap gap-2">
      <form method="get" class="row g-2 flex-grow-1">
        <div class="col-12 col-md-4">
          <input type="text"
                 name="q"
                 value="{{ q }}"
                 class="form-control"
                 placeholder="Hledat v názvu/popisu…">
        </div>
        <div class="col-6 col-md-2">
          <input type="date"
                 name="date_from"
                 value="{{ date_from }}"
                 class="form-control"
                 placeholder="Od data">
        </div>
        <div class="col-6 col-md-2">
          <input type="date"
                 name="date_to"
                 value="{{ date_to }}"
                 class="form-control"
                 placeholder="Do data">
        </div>
        <div class="col-6 col-md-2">
          <select name="has_assessment" class="form-select">
            <option value="">Hodnocení – všechna</option>
            <option value="yes" {% if has_assessment == 'yes' %}selected{% endif %}>Jen s hodnocením</option>
            <option value="no" {% if has_assessment == 'no' %}selected{% endif %}>Jen bez hodnocení</option>
          </select>
        </div>
        <div class="col-6 col-md-2">
          <select name="has_open_interventions" class="form-select">
            <option value="">Zásahy – všechny</option>
            <option value="open" {% if has_open_interventions == 'open' %}selected{% endif %}>S otevřenými zásahy</option>
            <option value="none" {% if has_open_interventions == 'none' %}selected{% endif %}>Bez zásahů</option>
          </select>
        </div>
        <div class="col-12 col-md-2 d-grid">
          <button class="btn btn-primary" type="submit">
            <i class="bi bi-funnel"></i> Filtrovat
          </button>
        </div>
      </form>
      <a class="btn btn-outline-primary btn-sm" href="{% url 'map_leaflet_test' %}?project={{ project.pk }}">
        <i class="bi bi-map"></i> Mapa projektu
      </a>
    </div>
  </div>
</div>

<form method="post" action="{% url 'export_selected_zip' project.pk %}">
  {% csrf_token %}

  <div class="d-flex justify-content-between align-items-center mb-2">
    <div>
      <input type="checkbox" id="selectAll" onclick="toggleAll(this)">
      <label for="selectAll" class="ms-1 small">Vybrat vše</label>
    </div>
    <div class="d-flex gap-2 flex-wrap">
      <button type="submit" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-download"></i> Exportovat vybrané
      </button>
      <button type="submit"
              name="export_all"
              value="1"
              class="btn btn-outline-primary btn-sm">
        <i class="bi bi-archive"></i> Exportovat celý projekt
      </button>
      <button type="submit"
              name="bulk_approve_interventions"
              value="1"
              class="btn btn-outline-success btn-sm"
              formaction="{% url 'bulk_approve_interventions' project.pk %}">
        <i class="bi bi-check2-circle"></i> Schválit navržené zásahy
      </button>
    </div>
  </div>

  <div class="vstack gap-2">
    {% for wr in page_obj.object_list %}
      <div class="card border-0 shadow-sm workrecord-row" data-href="{% url 'work_record_detail' wr.pk %}">
        <div class="card-body d-flex flex-column flex-md-row justify-content-between align-items-start gap-2">
          <div class="d-flex align-items-start gap-2 flex-grow-1">
            <div class="pt-1">
              <input type="checkbox"
                     name="selected_records"
                     value="{{ wr.id }}"
                     class="form-check-input me-2">
            </div>
            <div class="min-w-0">
              <div class="d-flex align-items-center gap-2 mb-1">
                <span class="fw-semibold text-truncate">
                  {{ wr.title|default:"Bez názvu" }}
                </span>
                <small class="text-muted">
                  {{ wr.date|date:"d.m.Y" }}
                </small>
              </div>

              {% if wr.taxon_czech or wr.taxon_latin or wr.taxon %}
                <div class="small text-muted">
                  Taxon:
                  {% if wr.taxon_czech %}
                    {{ wr.taxon_czech }}
                  {% elif wr.taxon %}
                    {{ wr.taxon }}
                  {% else %}
                    neurčený
                  {% endif %}
                  {% if wr.taxon_latin %}
                    ({{ wr.taxon_latin }})
                  {% endif %}
                </div>
              {% else %}
                <div class="small text-muted">
                  Taxon: neurčený
                </div>
              {% endif %}

              {% if wr.latest_assessment %}
                <div class="small text-muted">
                  DBH: {{ wr.latest_assessment.dbh_cm|default:"-" }} cm,
                  výška: {{ wr.latest_assessment.height_m|default:"-" }} m,
                  vitalita: {{ wr.latest_assessment.vitality|default:"-" }},
                  stabilita: {{ wr.latest_assessment.stability|default:"-" }}
                </div>
              {% else %}
                <div class="small text-muted">
                  Bez hodnocení.
                </div>
              {% endif %}

              {% if wr.intervention_count > 0 %}
                <div class="small mt-1">
                  <span class="text-muted">
                    Zásahy: {{ wr.intervention_count }} celkem
                    · navrženo: {{ wr.interventions_proposed }}
                    · schváleno: {{ wr.interventions_approved }}
                    · předáno ke kontrole: {{ wr.interventions_handover }}
                    · dokončeno: {{ wr.interventions_completed }}
                  </span>
                  {% if wr.max_urgency is not None %}
                    {% if wr.max_urgency == 0 or wr.max_urgency == 1 %}
                      <span class="badge bg-danger ms-1">Vysoká naléhavost</span>
                    {% else %}
                      <span class="badge bg-secondary ms-1">Střední / nízká naléhavost</span>
                    {% endif %}
                  {% endif %}
                </div>
              {% else %}
                <div class="small mt-1 text-muted">
                  Bez zásahů.
                </div>
              {% endif %}
            </div>
          </div>

          <div class="d-flex align-items-center gap-2">
            {% if wr.latitude and wr.longitude %}
              <i class="bi bi-geo-alt-fill text-success" title="Má polohu"></i>
            {% else %}
              <i class="bi bi-geo text-muted" title="Bez polohy"></i>
            {% endif %}
            <a href="{% url 'map_leaflet_test' %}?record={{ wr.id }}&project={{ project.pk }}"
               class="text-muted"
               title="Zobrazit v mapě">
              <i class="bi bi-map"></i>
            </a>
            <a href="{% url 'work_record_detail' wr.pk %}#intervence_new"
               class="btn btn-sm btn-outline-secondary">
              Zásahy
            </a>
          </div>
        </div>
      </div>
    {% empty %}
      <div class="alert alert-info">
        Žádné úkony neodpovídají filtru.
      </div>
    {% endfor %}
  </div>
</form>

<nav class="mt-3">
  <ul class="pagination">
    {% if page_obj.has_previous %}
      <li class="page-item">
        <a class="page-link"
           href="?page={{ page_obj.previous_page_number }}&q={{ q }}&date_from={{ date_from }}&date_to={{ date_to }}">
          «
        </a>
      </li>
    {% else %}
      <li class="page-item disabled">
        <span class="page-link">«</span>
      </li>
    {% endif %}

    <li class="page-item disabled">
      <span class="page-link">
        Strana {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}
      </span>
    </li>

    {% if page_obj.has_next %}
      <li class="page-item">
        <a class="page-link"
           href="?page={{ page_obj.next_page_number }}&q={{ q }}&date_from={{ date_from }}&date_to={{ date_to }}">
          »
        </a>
      </li>
    {% else %}
      <li class="page-item disabled">
        <span class="page-link">»</span>
      </li>
    {% endif %}
  </ul>
</nav>

<script>
function toggleAll(source) {
  const checkboxes = document.querySelectorAll('input[name="selected_records"]');
  checkboxes.forEach(cb => cb.checked = source.checked);
}

// Klikatelné řádky – mobil i desktop
document.querySelectorAll('.workrecord-row').forEach(row => {
  let moved = false;

  row.addEventListener('touchstart', () => moved = false, {passive: true});
  row.addEventListener('touchmove', () => moved = true, {passive: true});
  row.addEventListener('touchend', (e) => {
    if (!moved && !e.target.closest('input, button, a')) {
      window.location = row.dataset.href;
    }
  });

  row.addEventListener('click', (e) => {
    if (!e.target.closest('input, button, a')) {
      window.location = row.dataset.href;
    }
  });
});
</script>
{% endblock %}
