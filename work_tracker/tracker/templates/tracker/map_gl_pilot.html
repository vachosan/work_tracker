{% extends "tracker/base.html" %}
{% load static %}
{% block title %}MapLibre Pilot{% endblock %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/map_ui.css' %}">
<link rel="stylesheet" href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css">
<style>
  html, body { height: 100%; overflow: hidden; }
  body { margin: 0; background: #000; }
  nav.navbar,
  footer { display: none !important; }
  main.container { padding: 0 !important; max-width: none; }
  #map {
    position: fixed;
    inset: 0;
    z-index: 1;
  }
  #wr-label-overlay {
    position: fixed;
    inset: 0;
    z-index: 2;
    pointer-events: none;
    font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
  }
  .wr-label {
    position: absolute;
    font-size: 0.85rem;
    font-weight: 600;
    color: #111;
    text-shadow:
      0 0 4px rgba(255, 255, 255, 0.95),
      0 0 8px rgba(255, 255, 255, 0.75);
    white-space: nowrap;
    will-change: transform;
  }
</style>

<div id="map"></div>
<div id="wr-label-overlay"></div>

{% include "tracker/partials/map_ui.html" %}

<script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
<script>
  window.workTrackerMapUiConfig = {
    workRecordDetailApiBase: "{% url 'workrecord_detail_api' 0 %}".replace(/0\/?$/, ""),
    assessmentApiBase: "{% url 'workrecord_assessment_api' 0 %}".replace("0/assessment/", ""),
    mapUploadPhotoUrl: "{% url 'map_upload_photo' %}",
    csrfToken: "{{ csrf_token }}",
    interventionNoteData: {{ intervention_note_data_json|default:"{}" | safe }},
  };
</script>
<script src="{% static 'js/map_ui.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
    if (!window.maplibregl) {
      console.error('MapLibre GL JS is not available.');
      return;
    }

    const API_KEY = "{{ mapy_key|default:'' }}";
    const WORKRECORDS_GEOJSON_URL = "{% url 'workrecords_geojson' %}";
    const MAP_CREATE_RECORD_URL = "{% url 'map_create_work_record' %}";
    const CSRF_TOKEN = "{{ csrf_token }}";
    const taxonSuggestUrl = "{% url 'gbif_taxon_suggest' %}";
    const LABEL_MIN_ZOOM = 17;
    const LABEL_LIMIT = 200;
    const labelOverlay = document.getElementById('wr-label-overlay');
    let workrecordFeatures = [];
    let workrecordFeatureCollection = null;
    let selectedLat = null;
    let selectedLon = null;
    let newRecordCoords = null;

    const newRecordModal = document.getElementById('newRecordModal');
    const newRecordTitleInput = document.getElementById('newRecordTitle');
    const newRecordSaveBtn = document.getElementById('newRecordSaveBtn');
    const newRecordCancelBtn = document.getElementById('newRecordCancelBtn');
    const newRecordCloseBtn = document.getElementById('newRecordCloseBtn');
    const createFab = document.getElementById('createFab');
    const projectSelect = document.getElementById('projectSelect');
    const taxonDisplayInput = document.getElementById('taxon_display');
    const taxonCzechInput = document.getElementById('taxon_czech');
    const taxonLatinInput = document.getElementById('taxon_latin');
    const taxonGbifKeyInput = document.getElementById('taxon_gbif_key');
    const taxonSuggestionsList = document.getElementById('taxon-suggestions');
    const taxonFieldWrapper = document.getElementById('taxon-field-wrapper');

    function hideTaxonSuggestions() {
      if (!taxonSuggestionsList) return;
      taxonSuggestionsList.classList.remove('visible');
      taxonSuggestionsList.innerHTML = '';
    }

    function renderTaxonSuggestions(items) {
      if (!taxonSuggestionsList) return;
      taxonSuggestionsList.innerHTML = '';
      if (!items.length) {
        hideTaxonSuggestions();
        return;
      }
      items.forEach(item => {
        const li = document.createElement('li');
        const label = item.display || item.scientific_name || item.vernacular_name || '';
        li.textContent = label;
        li.className = 'list-group-item list-group-item-action';
        li.addEventListener('click', () => {
          if (taxonDisplayInput) taxonDisplayInput.value = label;
          if (taxonCzechInput) taxonCzechInput.value = item.vernacular_name || '';
          if (taxonLatinInput) taxonLatinInput.value = item.scientific_name || '';
          if (taxonGbifKeyInput) taxonGbifKeyInput.value = item.gbif_key || '';
          hideTaxonSuggestions();
        });
        taxonSuggestionsList.appendChild(li);
      });
      taxonSuggestionsList.classList.add('visible');
    }

    function requestTaxonSuggestions(query) {
      if (!taxonSuggestUrl || !query || query.length < 2) {
        hideTaxonSuggestions();
        return;
      }
      fetch(`${taxonSuggestUrl}?q=${encodeURIComponent(query)}`)
        .then(resp => resp.ok ? resp.json() : Promise.resolve({ results: [] }))
        .then(data => {
          renderTaxonSuggestions((data && data.results) || []);
        })
        .catch(() => hideTaxonSuggestions());
    }

    if (taxonDisplayInput) {
      taxonDisplayInput.addEventListener('input', () => {
        const value = taxonDisplayInput.value.trim();
        if (value.length < 2) {
          hideTaxonSuggestions();
          return;
        }
        requestTaxonSuggestions(value);
      });
      taxonDisplayInput.addEventListener('focus', () => {
        if (taxonSuggestionsList && taxonSuggestionsList.childElementCount) {
          taxonSuggestionsList.classList.add('visible');
        }
      });
    }

    document.addEventListener('click', (event) => {
      if (taxonFieldWrapper && !taxonFieldWrapper.contains(event.target)) {
        hideTaxonSuggestions();
      }
    });

    function resetNewRecordForm() {
      if (newRecordTitleInput) newRecordTitleInput.value = '';
      if (taxonDisplayInput) taxonDisplayInput.value = '';
      if (taxonCzechInput) taxonCzechInput.value = '';
      if (taxonLatinInput) taxonLatinInput.value = '';
      if (taxonGbifKeyInput) taxonGbifKeyInput.value = '';
      hideTaxonSuggestions();
    }

    function openNewRecordModal() {
      if (!newRecordModal) return;
      newRecordModal.classList.add('active');
    }

    function closeNewRecordModal() {
      if (!newRecordModal) return;
      newRecordModal.classList.remove('active');
      hideTaxonSuggestions();
    }

    if (newRecordCancelBtn) {
      newRecordCancelBtn.addEventListener('click', closeNewRecordModal);
    }
    if (newRecordCloseBtn) {
      newRecordCloseBtn.addEventListener('click', closeNewRecordModal);
    }
    if (newRecordModal) {
      newRecordModal.addEventListener('click', (e) => {
        if (e.target === newRecordModal) {
          closeNewRecordModal();
        }
      });
    }

    function updateNewRecordMarker(lngLat) {
      newRecordCoords = [lngLat.lng, lngLat.lat];
      const source = map.getSource('new-record-point');
      if (!source) return;
      source.setData({
        type: 'FeatureCollection',
        features: [
          {
            type: 'Feature',
            geometry: { type: 'Point', coordinates: newRecordCoords },
            properties: {},
          },
        ],
      });
    }

    function clearNewRecordMarker() {
      const source = map.getSource('new-record-point');
      if (source) {
        source.setData({ type: 'FeatureCollection', features: [] });
      }
      newRecordCoords = null;
    }

    function submitNewRecord() {
      if (!newRecordSaveBtn) return;
      if (selectedLat === null || selectedLon === null) {
        alert('Nejdřív klikni do mapy a vyber bod.');
        return;
      }
      const title = newRecordTitleInput ? newRecordTitleInput.value.trim() : '';
      const displayTaxon = taxonDisplayInput ? taxonDisplayInput.value.trim() : '';
      const latinTaxon = taxonLatinInput ? taxonLatinInput.value.trim() : '';
      const czechTaxon = taxonCzechInput ? taxonCzechInput.value.trim() : '';
      const gbifKeyValue = taxonGbifKeyInput ? taxonGbifKeyInput.value.trim() : '';
      const projectId = projectSelect ? projectSelect.value : '';
      const taxonValue = latinTaxon || displayTaxon;

      newRecordSaveBtn.disabled = true;
      const payload = new URLSearchParams({
        title: title,
        taxon: taxonValue,
        taxon_czech: czechTaxon,
        taxon_latin: latinTaxon,
        taxon_gbif_key: gbifKeyValue,
        date: '',
        project_id: projectId && projectId !== 'none' ? projectId : '',
        latitude: selectedLat,
        longitude: selectedLon,
      });

      fetch(MAP_CREATE_RECORD_URL, {
        method: 'POST',
        headers: {
          'X-CSRFToken': CSRF_TOKEN,
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: payload.toString(),
      })
        .then(resp => resp.json())
        .then(data => {
          if (data.status === 'ok' && data.record) {
            resetNewRecordForm();
            closeNewRecordModal();
            clearNewRecordMarker();
            selectedLat = null;
            selectedLon = null;
            const rec = data.record;
            const label = rec.external_tree_id || rec.title || `WR ${rec.id}`;
            const feature = {
              type: 'Feature',
              geometry: { type: 'Point', coordinates: [rec.lon, rec.lat] },
              properties: { id: rec.id, label },
            };
            workrecordFeatures.push({ id: rec.id, label, coordinates: [rec.lon, rec.lat] });
            if (!workrecordFeatureCollection) {
              workrecordFeatureCollection = { type: 'FeatureCollection', features: [] };
            }
            workrecordFeatureCollection.features.push(feature);
            const src = map.getSource('workrecords');
            if (src && typeof src.setData === 'function') {
              src.setData(workrecordFeatureCollection);
            }
            renderLabelOverlay();
            if (window.openWorkRecordPanel) {
              window.openWorkRecordPanel(data.record.id);
            }
          } else {
            alert(data.msg || 'Nepodařilo se uložit strom.');
          }
        })
        .catch(() => {
          alert('Chyba při ukládání stromu.');
        })
        .finally(() => {
          newRecordSaveBtn.disabled = false;
        });
    }

    if (newRecordSaveBtn) {
      newRecordSaveBtn.addEventListener('click', submitNewRecord);
    }

    if (createFab) {
      createFab.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        if (!newRecordCoords) {
          alert('Nejdřív vyber místo kliknutím do mapy.');
          return;
        }
        openNewRecordModal();
      });
    }
    const sanitizeUrl = (value) => {
      if (typeof value !== 'string') return value;
      const [base] = value.split('?');
      return base;
    };
    const sanitizeErrorValue = (value) => {
      if (!value) return value;
      if (typeof value === 'string') {
        return value.replace(/([?&])apikey=[^&]+/gi, '$1apikey=***');
      }
      if (typeof value === 'object') {
        const clone = Array.isArray(value) ? [...value] : { ...value };
        if (clone.url) clone.url = sanitizeUrl(clone.url);
        if (clone.resource && typeof clone.resource === 'object' && clone.resource.url) {
          clone.resource = { ...clone.resource, url: sanitizeUrl(clone.resource.url) };
        }
        return clone;
      }
      return value;
    };

    const aerialTiles = `https://api.mapy.com/v1/maptiles/aerial/256/{z}/{x}/{y}?apikey=${API_KEY}`;
    const namesTiles = `https://api.mapy.com/v1/maptiles/names-overlay/256/{z}/{x}/{y}?apikey=${API_KEY}`;

    if (!API_KEY) {
      console.error('MapLibre error', 'Missing Mapy.com API key.');
    }
    console.log('Mapy tiles configured', {
      aerial: sanitizeUrl(aerialTiles),
      names: sanitizeUrl(namesTiles),
    });

    const style = {
      version: 8,
      sources: {
        'mapy-aerial': {
          type: 'raster',
          tiles: [aerialTiles],
          tileSize: 256,
          minzoom: 3,
          maxzoom: 20,
          attribution: '© <a href="https://mapy.cz/">Seznam.cz a.s.</a>',
        },
        'mapy-names': {
          type: 'raster',
          tiles: [namesTiles],
          tileSize: 256,
          minzoom: 3,
          maxzoom: 20,
          attribution: '© <a href="https://mapy.cz/">Seznam.cz a.s.</a>',
        },
      },
      layers: [
        {
          id: 'background',
          type: 'background',
          paint: { 'background-color': '#dde6f1' },
        },
        {
          id: 'mapy-aerial',
          type: 'raster',
          source: 'mapy-aerial',
        },
        {
          id: 'mapy-names',
          type: 'raster',
          source: 'mapy-names',
          paint: { 'raster-opacity': 1 },
        },
      ],
    };

    const map = new maplibregl.Map({
      container: 'map',
      style,
      center: [17.2509, 49.5938], // Olomouc
      zoom: 13,
    });

    const clearLabelOverlay = () => {
      if (!labelOverlay) return;
      if (typeof labelOverlay.replaceChildren === 'function') {
        labelOverlay.replaceChildren();
      } else {
        labelOverlay.innerHTML = '';
      }
    };

    const renderLabelOverlay = () => {
      if (!labelOverlay || !workrecordFeatures.length) {
        clearLabelOverlay();
        return;
      }
      const zoom = map.getZoom();
      if (Number.isFinite(zoom) && zoom < LABEL_MIN_ZOOM) {
        clearLabelOverlay();
        return;
      }
      const bounds = map.getBounds();
      const fragment = document.createDocumentFragment();
      let rendered = 0;
      for (const feature of workrecordFeatures) {
        if (!feature) continue;
        const coords = feature.coordinates;
        if (!Array.isArray(coords) || coords.length < 2) continue;
        const [lng, lat] = coords;
        if (!bounds || typeof bounds.contains !== 'function' || !bounds.contains([lng, lat])) {
          continue;
        }
        const labelText = feature.label || (feature.id ? `WR ${feature.id}` : '');
        if (!labelText) continue;
        const point = map.project([lng, lat]);
        const el = document.createElement('div');
        el.className = 'wr-label';
        el.textContent = labelText;
        el.style.transform = `translate(${point.x}px, ${point.y}px) translate(-50%, -130%)`;
        fragment.appendChild(el);
        rendered += 1;
        if (rendered >= LABEL_LIMIT) break;
      }
      if (typeof labelOverlay.replaceChildren === 'function') {
        labelOverlay.replaceChildren(fragment);
      } else {
        labelOverlay.innerHTML = '';
        labelOverlay.appendChild(fragment);
      }
    };

    map.on('move', renderLabelOverlay);
    map.on('zoom', renderLabelOverlay);
    map.on('rotate', renderLabelOverlay);

    map.on('load', () => {
      console.log('Map loaded');
      const coarsePointer = window.matchMedia && window.matchMedia('(pointer: coarse)').matches;
      const HIT_TOLERANCE = coarsePointer ? 12 : 6;

      fetch(WORKRECORDS_GEOJSON_URL)
        .then(resp => resp.json())
        .then(fc => {
          const features = Array.isArray(fc && fc.features) ? fc.features : [];
          console.log('GeoJSON features:', features.length);
          console.log('Sample labels:', features.slice(0, 3).map(f => f && f.properties ? f.properties.label : null));
          workrecordFeatures = features
            .map(feature => {
              if (!feature || !feature.geometry || !feature.properties) return null;
              const coords = feature.geometry.coordinates;
              if (!Array.isArray(coords) || coords.length < 2) return null;
              return {
                id: feature.properties.id,
                label: feature.properties.label,
                coordinates: coords,
              };
            })
            .filter(Boolean);
          workrecordFeatureCollection = fc;
          renderLabelOverlay();
        })
        .catch(err => console.error('GeoJSON debug error', err));

      map.addSource('workrecords', {
        type: 'geojson',
        data: WORKRECORDS_GEOJSON_URL,
        cluster: true,
        clusterRadius: 25,
        clusterMaxZoom: 15,
      });

      map.addLayer({
        id: 'workrecord-clusters',
        type: 'circle',
        source: 'workrecords',
        filter: ['has', 'point_count'],
        paint: {
          'circle-color': '#1f6feb',
          'circle-radius': [
            'step',
            ['get', 'point_count'],
            15,
            10, 20,
            30, 25,
          ],
          'circle-opacity': 0.85,
        },
      });

      map.addLayer({
        id: 'workrecord-cluster-count',
        type: 'symbol',
        source: 'workrecords',
        filter: ['has', 'point_count'],
        layout: {
          'text-field': ['get', 'point_count_abbreviated'],
          'text-font': ['Open Sans Bold', 'Arial Unicode MS Bold'],
          'text-size': 12,
        },
        paint: {
          'text-color': '#fff',
        },
      });

      map.addLayer({
        id: 'workrecord-unclustered',
        type: 'circle',
        source: 'workrecords',
        filter: ['!', ['has', 'point_count']],
        paint: {
          'circle-color': '#f97316',
          'circle-radius': 5,
          'circle-stroke-width': 1,
          'circle-stroke-color': '#fff',
        },
      });

      map.addLayer({
        id: 'workrecord-hitarea',
        type: 'circle',
        source: 'workrecords',
        filter: ['!', ['has', 'point_count']],
        paint: {
          'circle-color': '#000000',
          'circle-opacity': 0,
          'circle-radius': 16,
        },
      });

      map.addSource('new-record-point', {
        type: 'geojson',
        data: { type: 'FeatureCollection', features: [] },
      });

      map.addLayer({
        id: 'new-record-point',
        type: 'circle',
        source: 'new-record-point',
        paint: {
          'circle-color': '#10b981',
          'circle-radius': 7,
          'circle-stroke-width': 2,
          'circle-stroke-color': '#fff',
        },
      });

      const expandCluster = (feature) => {
        if (!feature) return;
        const rawClusterId = feature.properties && feature.properties.cluster_id;
        const clusterId = rawClusterId !== undefined ? Number(rawClusterId) : null;
        if (clusterId === undefined || clusterId === null) return;
        const source = map.getSource('workrecords');
        if (!source || typeof source.getClusterExpansionZoom !== 'function') return;
        source.getClusterExpansionZoom(clusterId, (error, zoom) => {
          if (error) {
            console.error('MapLibre error', sanitizeErrorValue(error));
            return;
          }
          console.log('cluster click', clusterId, zoom);
          map.easeTo({
            center: feature.geometry.coordinates,
            zoom,
          });
        });
      };

      map.on('click', 'workrecord-clusters', (event) => {
        const features = map.queryRenderedFeatures(event.point, { layers: ['workrecord-clusters'] });
        const feature = features && features[0];
        if (!feature) return;
        expandCluster(feature);
      });

      const handleWorkRecordClick = (event, layers) => {
        const layerIds = Array.isArray(layers) ? layers : ['workrecord-unclustered'];
        const features = map.queryRenderedFeatures(event.point, { layers: layerIds });
        const feature = features && features[0];
        if (!feature) return;
        const recordId = feature.properties && feature.properties.id;
        const label = feature.properties && feature.properties.label;
        if (recordId && window.openWorkRecordPanel) {
          window.openWorkRecordPanel(recordId, { label });
        }
      };

      map.on('click', 'workrecord-unclustered', (event) => {
        handleWorkRecordClick(event, ['workrecord-unclustered']);
      });
      map.on('click', 'workrecord-hitarea', (event) => {
        handleWorkRecordClick(event, ['workrecord-hitarea']);
      });

      const setPointer = () => { map.getCanvas().style.cursor = 'pointer'; };
      const resetPointer = () => { map.getCanvas().style.cursor = ''; };
      map.on('mouseenter', 'workrecord-clusters', setPointer);
      map.on('mouseleave', 'workrecord-clusters', resetPointer);
      map.on('mouseenter', 'workrecord-unclustered', setPointer);
      map.on('mouseleave', 'workrecord-unclustered', resetPointer);
      map.on('mouseenter', 'workrecord-hitarea', setPointer);
      map.on('mouseleave', 'workrecord-hitarea', resetPointer);
      map.on('click', (event) => {
        const bbox = [
          [event.point.x - HIT_TOLERANCE, event.point.y - HIT_TOLERANCE],
          [event.point.x + HIT_TOLERANCE, event.point.y + HIT_TOLERANCE],
        ];
        const unclustered = map.queryRenderedFeatures(bbox, { layers: ['workrecord-hitarea', 'workrecord-unclustered'] });
        if (unclustered && unclustered.length) {
          const recordId = unclustered[0].properties && unclustered[0].properties.id;
          const label = unclustered[0].properties && unclustered[0].properties.label;
          if (recordId && window.openWorkRecordPanel) {
            window.openWorkRecordPanel(recordId, { label });
          }
          return;
        }
        const clusters = map.queryRenderedFeatures(bbox, { layers: ['workrecord-clusters'] });
        if (clusters && clusters.length) {
          expandCluster(clusters[0]);
          return;
        }
        const lngLat = event.lngLat;
        if (!lngLat) return;
        if (window.closeWorkRecordPanel) {
          window.closeWorkRecordPanel();
        }
        selectedLat = lngLat.lat.toFixed(7);
        selectedLon = lngLat.lng.toFixed(7);
        window.selectedLat = selectedLat;
        window.selectedLon = selectedLon;
        updateNewRecordMarker(lngLat);
        resetNewRecordForm();
      });
    });
    map.on('error', (e) => {
      const err = sanitizeErrorValue(e?.error || e);
      console.error('MapLibre error', err);
    });

    map.addControl(new maplibregl.NavigationControl(), 'top-right');
  });
</script>
{% endblock %}
