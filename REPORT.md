# Souhrn (5–10 bodů)
1. Map contexts are built via `_build_map_mapui_context`, which restricts WorkRecords to `user_projects_qs(request.user)` plus project-less trees while prefetching photos and assessments for the map UI (`work_tracker/tracker/views.py:870`).
2. Leaflet’s fullscreen map receives `records_for_select`, `records_with_coords`, and `projects_js` via `json_script`, lets users filter through a `projectSelect` dropdown, and renders clustered markers via `L.markerClusterGroup` before calling `updateMarkers` (`work_tracker/tracker/templates/tracker/map_leaflet.html:27`, `work_tracker/tracker/templates/tracker/partials/map_ui.html:234`, `work_tracker/tracker/templates/tracker/map_leaflet.html:428`, `work_tracker/tracker/templates/tracker/map_leaflet.html:566`).
3. The MapLibre pilot hits `workrecords_geojson` to hydrate GL layers and clustering while preserving cluster/point hit area layers, but that endpoint currently returns every geocoded WorkRecord regardless of project membership (`work_tracker/tracker/templates/tracker/map_gl_pilot.html:63`, `work_tracker/tracker/views.py:942`).
4. The interactive map uses `workrecord_detail_api`, `map_upload_photo`, `save_coordinates`, and `map_create_work_record` to fetch photos/assessments, persist photos, save coordinates, and create records while each view double-checks `user_can_view_project` (`work_tracker/tracker/views.py:1057`, `work_tracker/tracker/views.py:1170`, `work_tracker/tracker/views.py:1141`, `work_tracker/tracker/views.py:1208`).
5. `user_can_view_project`/`user_projects_qs` (from `work_tracker/tracker/permissions.py:4`) guard every project-specific page (`project_detail`, `work_record_detail`, exports) and map contexts, while `ProjectMembership` lookups gate `edit_project` to foremen when needed (`work_tracker/tracker/views.py:81`, `work_tracker/tracker/views.py:194`).
6. The detailed tree card pulls the latest assessment via `WorkRecord.latest_assessment`, renders the full assessment history, interventions, and photo gallery, and accepts new photos (`work_tracker/tracker/views.py:426`, `work_tracker/tracker/models.py:192`, `work_tracker/tracker/templates/tracker/work_record_detail.html:105`).
7. Create/edit flows capture latitude/longitude from either the form or the map `selectedLat/selectedLon`, `save_coordinates` lets users adjust locations, and the only export endpoint is `export_selected_zip` scoped to a project; no nearest/duplicate check safeguards exist because the model/form stack does not enforce uniqueness (`work_tracker/tracker/views.py:343`, `work_tracker/tracker/views.py:602`, `work_tracker/tracker/views.py:681`, `work_tracker/tracker/models.py:96`).

# Mapa – data flow
- `_build_map_mapui_context` pulls `visible_projects = user_projects_qs(request.user)` and builds `records` plus `coords_qs` (lat/lon only) annotated with photo/assessment counts before handing the lists to the template (`work_tracker/tracker/views.py:870`).
- `map_leaflet.html` serializes `records_for_select`, `records_with_coords`, and `projects_js` through `json_script`, and the project dropdown is rendered inside `partials/map_ui.html` (`work_tracker/tracker/templates/tracker/map_leaflet.html:27`, `work_tracker/tracker/templates/tracker/partials/map_ui.html:234`).
- `updateMarkers` clears the `L.markerClusterGroup` (disable clustering at zoom 17) and, when `projectSelect` changes, only keeps markers whose `project_id` matches the selected value or `'none'` for project-less trees (`work_tracker/tracker/templates/tracker/map_leaflet.html:428`, `work_tracker/tracker/templates/tracker/map_leaflet.html:566`). Map view geometry is persisted in `localStorage` so move/zoom are restored between visits (`work_tracker/tracker/templates/tracker/map_leaflet.html:228`).
- Marker clicks drill into `workrecord_detail_api` via `ensureRecordDetails`, which eagerly loads photos for the bottom panel; `map_upload_photo` and `map_create_work_record` supply the AJAX endpoints for uploading new photos and creating trees from the map interface (`work_tracker/tracker/templates/tracker/map_leaflet.html:419`, `work_tracker/tracker/views.py:1057`, `work_tracker/tracker/views.py:1170`, `work_tracker/tracker/views.py:1208`).
- MapLibre GL reuses the same UI shell but fetches `workrecords_geojson` (optionally honored `bbox` but never passed by the pilot) to build clustered Point/Circle layers, handle cluster expansion, and render label overlays; the GL UI supplies the selected `projectSelect` value when POSTing to `map_create_work_record` (`work_tracker/tracker/templates/tracker/map_gl_pilot.html:63`, `work_tracker/tracker/templates/tracker/map_gl_pilot.html:567`, `work_tracker/tracker/templates/tracker/map_gl_pilot.html:598`, `work_tracker/tracker/templates/tracker/map_gl_pilot.html:224`, `work_tracker/tracker/views.py:942`, `work_tracker/tracker/views.py:951`).

# Projekty a vazba WorkRecord→Project
- `WorkRecord.project` is a nullable FK and `WorkRecordForm` only exposes one project from `Project.objects.filter(is_closed=False)`, so a tree can either belong to one open project or be project-less; map filters include a `none` option to surface unassigned trees (`work_tracker/tracker/models.py:117`, `work_tracker/tracker/forms.py:68`, `work_tracker/tracker/templates/tracker/partials/map_ui.html:234`).
- The standard creation view respects optional `project_id` from `/tracker/create/<project_id>/`, saves latitude/longitude from query params or POST, and then checks `user_can_view_project` before returning to the detail page (`work_tracker/tracker/views.py:343`).
- `project_detail` only looks at trees inside the requested project and sets `is_member`/`is_foreman` flags from `ProjectMembership`, so only project-level data shows there (`work_tracker/tracker/views.py:81`, `work_tracker/tracker/views.py:125`).
- Map contexts expand the query to `Q(project__in=visible_projects) | Q(project__isnull=True)`, so users see their projects plus detached trees (`work_tracker/tracker/views.py:874`).

# Oprávnění a membership
- `user_can_view_project` and `user_projects_qs` (defined in `tracker/permissions.py:4`) are the shared helpers used by `project_detail`, tree detail, photo uploads, interventions, exports, etc., always after `@login_required` (`work_tracker/tracker/views.py:81`, `work_tracker/tracker/views.py:426`, `work_tracker/tracker/views.py:514`, `work_tracker/tracker/views.py:602`).
- Some views (e.g., `edit_project`) hardcode a `ProjectMembership` lookup for `Role.FOREMAN` because there is no `user_can_edit_project` helper (`work_tracker/tracker/views.py:194`, `work_tracker/tracker/models.py:295`).
- Map endpoints rely on `user_projects_qs` to supply only the projects you belong to, but the pilot `workrecords_geojson` endpoint does not check membership at all, so it returns every geocoded record (`work_tracker/tracker/views.py:870`, `work_tracker/tracker/views.py:942`).

# Detail stromu (assessment/intervention/photos)
- `work_record_detail` prefetches `assessments`, `photos`, and `interventions`, guards the project, and provides `PhotoDocumentationForm` for uploads before rendering the template (`work_tracker/tracker/views.py:426`).
- The template surfaces the latest assessment via `work_record.latest_assessment`, renders the full history sorted by `assessed_at`, and shows DBH/vitality/stability/perspective details (`work_tracker/tracker/models.py:192`, `work_tracker/tracker/templates/tracker/work_record_detail.html:105`, `work_tracker/tracker/templates/tracker/work_record_detail.html:193`).
- Interventions appear in their own card with urgency/status/due date/description columns and links to `tree_intervention_update` (`work_tracker/tracker/templates/tracker/work_record_detail.html:245`).
- Photodocumentation is rendered as a gallery and the bottom form allows camera/gallery uploads; the same photos power the map popups via `workrecord_detail_api` (`work_tracker/tracker/templates/tracker/work_record_detail.html:362`).

# Vytváření/editace/duplicitní ochrana
- `create_work_record` and `edit_work_record` both save lat/lon from inputs, call `sync_title_from_identifiers`, guard projects via `user_can_view_project`, and allow a photo attachment before redirecting to the detail view (`work_tracker/tracker/views.py:343`, `work_tracker/tracker/views.py:602`).
- `save_coordinates` is the AJAX endpoint the map’s “save” FAB hits to persist new GPS values, and `map_create_work_record` enforces that lat/lon arrive with each new tree while still letting `project_id` be optional (`work_tracker/tracker/views.py:1141`, `work_tracker/tracker/views.py:1208`).
- The Leaflet UI fills `selectedLat/selectedLon` from clicks before the `createFab` redirects to `/tracker/create/` (with the project ID if a project is chosen), so the map bootstraps coordinates in the standard form (`work_tracker/tracker/templates/tracker/map_leaflet.html:394`).
- No code path searches for nearest neighbors or dedupes trees: the `WorkRecord` model has no uniqueness on coordinates or IDs beyond `pk`, and an `rg` search for `nearest`/`duplicate` returns nothing, so duplicate lat/lon entries are currently permitted (`work_tracker/tracker/models.py:96`).

# Exporty
- `export_selected_zip` streams project-limited ZIPs of each tree’s photos after a membership guard and either the selected IDs or all trees in the project, building a ZIP per project name and today’s date (`work_tracker/tracker/views.py:681`).

# Zjištěné “pain points” + doporučení co upravit, aby šlo:
- **Zobrazovat všechny stromy globálně:** `_build_map_mapui_context` restricts records to `user_projects_qs` and the Leaflet UI never loads anything beyond those projects (`work_tracker/tracker/views.py:870`); to support a global overview, introduce a flag/permission that relaxes that filter or add a dedicated “public map” endpoint that aggregates all WorkRecords after a higher-level permission check, and ensure `workrecords_geojson` enforces the same guard instead of returning every geocoded tree (`work_tracker/tracker/views.py:942`).
- **Mít stromy v mnoha projektech:** `WorkRecord` currently stores a single `project` FK exposed by `WorkRecordForm` and the map creation helper (`work_tracker/tracker/models.py:117`, `work_tracker/tracker/forms.py:68`, `work_tracker/tracker/templates/tracker/map_gl_pilot.html:224`); to list a tree in multiple student/obecní projekt dripstreams you’d need a through-table or ManyToMany, adjust forms/map filters to accept multi-select projects, and update the API to return the full project list for each tree.
- **Přidat crowdsourced pozorování (“wiki” události):** there is no `Observation`/`Event` model (`rg Observation work_tracker` returned no hits), so only interventions and photo docs are available; implement a lightweight `TreeObservation` model plus detail/map UI hooks (maybe piggybacking on `workrecord_detail_api`) so volunteers can drop notes/photos that are not formal interventions.
